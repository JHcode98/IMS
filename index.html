<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- <meta name="viewport" content="width=device-width,initial-scale=1" />-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Inventory Management System</title>
		<link rel="stylesheet" href="styles.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
		<style>
			#app-sidebar, header, main {
				transition: all 0.3s ease;
			}

			/* Glassmorphism Login Styles */
			#login-section {
				background: rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(12px);
				-webkit-backdrop-filter: blur(12px);
				border: 1px solid rgba(255, 255, 255, 0.2);
				box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
				border-radius: 16px;
				color: #fff;
			}
			#login-section h2, #login-section h3, #login-section label {
				color: #fff;
				text-shadow: 0 1px 2px rgba(0,0,0,0.4);
			}
			#login-section input, #login-section select {
				background: rgba(255, 255, 255, 0.2);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: #fff;
			}
			#login-section input::placeholder {
				color: rgba(255, 255, 255, 0.7);
			}
			/* Autofill fix */
			#login-section input:-webkit-autofill,
			#login-section input:-webkit-autofill:hover, 
			#login-section input:-webkit-autofill:focus, 
			#login-section input:-webkit-autofill:active{
				-webkit-box-shadow: 0 0 0 30px rgba(255, 255, 255, 0.1) inset !important;
				-webkit-text-fill-color: white !important;
				transition: background-color 5000s ease-in-out 0s;
			}
			#login-section a {
				color: #eef;
				text-decoration: underline;
			}
			#login-section .muted {
				color: rgba(255, 255, 255, 0.8);
			}
			#login-section code {
				background: rgba(0,0,0,0.3);
				color: #fff;
			}
		</style>
	</head>
	<body class="no-navbar">
		<!-- Main App Sidebar -->
		<nav id="app-sidebar">
			<div class="sidebar-brand">
				<span class="brand-text">IMS</span>
				<button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
				</button>
			</div>
			<ul class="sidebar-menu">
				<li>
					<button id="nav-dms-btn" class="active" data-tooltip="Document Monitoring">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
						<span class="menu-text">Document Monitoring</span>
					</button>
					<ul class="sidebar-submenu" style="display: block;">
						<li><button onclick="window.location.href='index.html'">IAAF Monitoring</button></li>
						<li><button onclick="window.location.href='ir_monitoring.html'">IR Monitoring</button></li>
					</ul>
				</li>
				<li>
					<button id="nav-inventory-btn" data-tooltip="Inventory Tracker"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg><span class="menu-text">Inventory Tracker</span></button>
					<ul class="sidebar-submenu">
						<li><button onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
						<li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
						<li><button onclick="window.location.href='cycle_count_completion.html'">Cycle Count Completion</button></li>
					</ul>
				</li>
				<li><button id="nav-settings-btn" onclick="window.location.href='settings.html'" data-tooltip="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span class="menu-text">Settings</span></button></li>
			</ul>
		</nav>
		<header>
			<h1>Inventory Management System</h1>

				<div class="navbar" role="navigation">
					<div class="nav-left">
						<a href="documents_full.html" id="documents-full-page-btn" class="nav-btn" title="Open Full Documents View">Full Docs</a>
						<a href="admin_inbox.html" id="admin-inbox-page-btn" class="nav-btn" style="display:none" title="Open Admin Inbox Page">Admin Inbox <span id="admin-inbox-badge" class="badge" style="display:none"></span></a>
						<a href="recycle_bin.html" id="recycle-bin-page-btn" class="nav-btn" style="display:none" title="Open Recycle Bin">Recycle Bin</a>
						<a href="users-dashboard.html" id="users-dashboard-page-btn" class="nav-btn" style="display:none" title="Open Users Dashboard">Users</a>
					</div>
					<button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
							<div class="nav-right">
								<div id="clock" class="clock" aria-live="polite"></div>
								<div id="sr-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
								<div class="nav-user" id="nav-user">
									<button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
									<div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
										<a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
										<button id="dark-mode-toggle" role="menuitem">Dark Mode</button>
										<button id="logout-btn" role="menuitem">Logout</button>
									</div>
								</div>
							</div>
				</div>


		</header>


		<main>
			<!-- Login Form -->
			<section id="login-section" class="card">
				<h2>Login</h2>
				<form id="login-form">
					<label for="username">Username</label>
					<input id="username" name="username" required />

					<label for="password">Password</label>
					<input id="password" name="password" type="password" required />

					<button type="submit">Sign In</button>
					<div style="margin-top:8px"><a href="#" id="forgot-password-link">Forgot password?</a></div>
				</form>

				<!-- Registration (toggle) -->
				<div style="margin-top:12px">
					<button id="show-register" type="button">Create account</button>
				</div>
				<form id="register-form" class="hidden" style="margin-top:12px">
					<h3>Create account</h3>
					<label for="reg-username">Username</label>
					<input id="reg-username" name="reg-username" />

					<label for="reg-password">Password</label>
					<input id="reg-password" name="reg-password" type="password" />

					<label for="reg-password-confirm">Confirm Password</label>
					<input id="reg-password-confirm" name="reg-password-confirm" type="password" />

					<label for="reg-role">Role</label>
					<select id="reg-role" name="reg-role">
						<option value="user" selected>User</option>
						<option value="admin">Admin</option>
					</select>

					<div class="form-actions" style="margin-top:8px">
						<button id="register-btn" type="submit">Register</button>
						<button id="cancel-register" type="button">Cancel</button>
					</div>
				</form>
				<p class="muted">Default demo credentials: <code>admin</code> / <code>password</code></p>
			</section>


			<!-- Dashboard -->
			<section id="dashboard" class="hidden">
				<div class="layout">
					<aside id="left-sidebar" class="card left-sidebar">
						<div class="sidebar-controls" style="margin-bottom:10px;display:flex;gap:8px;align-items:center;">
							<input id="sidebar-search" placeholder="Search sidebar..." style="flex:1;padding:6px;border:1px solid #e6eef8;border-radius:6px" />
							<select id="sidebar-page-size" style="padding:6px;border:1px solid #e6eef8;border-radius:6px">
								<option value="5">5</option>
								<option value="8" selected>8</option>
								<option value="12">12</option>
							</select>
						</div>

						<h3>Routing by Status</h3>
						<div id="approved-by-status" class="approved-list"></div>
						<div id="by-status-pagination" class="sidebar-pagination" style="margin-bottom:10px"></div>
						<hr />
						<h3>Revision by Status</h3>
						<div id="approved-by-wins" class="approved-list"></div>
						<div id="by-wins-pagination" class="sidebar-pagination" style="margin-bottom:10px"></div>
					</aside>						<!-- Sidebar toggle placed as sibling so it remains clickable when sidebar is collapsed -->
						<button id="sidebar-toggle" class="sidebar-toggle" aria-expanded="true" title="Hide sidebar">â€¹</button>					<div class="main-column">
						<div class="controls">
					<div class="left"></div>
					<div class="right">
						<button id="new-doc-btn">New Document</button>
						<input id="search-control" placeholder="Search control number..." />
						<button id="search-btn">Search</button>
						<button id="filter-30-days" title="Show only documents from the last 30 days" style="padding: 6px 10px; font-size: 13px;">Last 30 Days</button>
						<button id="clear-search">Clear</button>
						<button id="bulk-update">Update Selected</button>
						<button id="bulk-delete">Delete Selected</button>
						<input id="import-file" type="file" accept=".csv" />
						<button id="download-template">Download Template</button>
						<button id="export-csv">Export CSV</button>
					</div>
				</div>

				<!-- Dashboard Charts -->
				<div id="dashboard-charts" class="card" style="margin-bottom: 20px;">
					<h3>Dashboard Analytics</h3>
					<div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-around;">
						<div style="flex: 1; min-width: 300px; max-width: 400px;">
							<canvas id="dash-pie-title" style="max-height:300px"></canvas>
						</div>
						<div style="flex: 1; min-width: 300px; max-width: 400px;">
							<canvas id="dash-bar-owner" style="max-height:300px"></canvas>
						</div>
						<div style="flex: 1; min-width: 300px; max-width: 100%;">
							<canvas id="dash-line-week" style="max-height:300px"></canvas>
						</div>
					</div>
				</div>

				<div id="new-doc-form" class="card hidden">
            <h3>Add Document</h3>
            <form id="doc-form">
              <label for="control-number">Control Number</label>
			  <input id="control-number" name="controlNumber" placeholder="ECOM-20XX-XXXX" pattern="ECOM-[0-9]{4}-[0-9]{4}" title="Format: ECOM-YYYY-NNNN (e.g. ECOM-2026-0001)" required />

							<label for="doc-title">Title</label>
							<select id="doc-title" name="title">
								<option>Cycle Count</option>
								<option>Retrieval Concerns</option>
								<option>B1T1 Adj</option>
								<option>LBR</option>
								<option>Rejected Claims</option>
								<option>SIS</option>
								<option>Expired</option>
								<option>Damaged</option>
								<option>Manual Picked</option>
								<option>Receiving Error</option>
								<option>Other</option>
							</select>
							<input id="doc-title-other" name="titleOther" placeholder="Other title" style="display:none;margin-top:6px" />

              <label for="doc-notes">Notes</label>
              <textarea id="doc-notes" name="notes" rows="3"></textarea>

              <label for="doc-owner">Owner</label>
              <input id="doc-owner" name="owner" />

              <label for="doc-status">Status</label>
              <select id="doc-status" name="status">
                <option>Revision</option>
                <option>Routing</option>
                <option>Approved</option>
                <option>Rejected</option>
              </select>

              <label for="wins-status">WINS Status</label>
              <select id="wins-status" name="winsStatus">
                <option>Approved</option>
                <option>Pending for Approve</option>
                <option>Rejected</option>
              </select>

              <label for="admin-status">Admin Status</label>
              <select id="admin-status" name="adminStatus">
                <option value="">Need User Attention</option>
                <option>Approved</option>
                <option>Rejected</option>
              </select>

              <label for="created-at">Created (modify)</label>
              <input id="created-at" name="createdAt" type="datetime-local" />

              <div class="form-actions">
                <button type="submit">Save</button>
                <button type="button" id="cancel-new">Cancel</button>
              </div>
            </form>
          </div>



				<div id="results" class="card">
	
					<div style="margin-top:12px;text-align:right;padding:10px">
						<a href="documents_full.html" style="font-weight:bold;text-decoration:none;color:#2752a7">View Full Documents List &rarr;</a>
					</div>
				</div>
			</div>
			<aside id="sidebar" class="card">
				<h3>Total Documents</h3>
				<div id="total-docs" class="total-docs-display" aria-hidden="false"></div>

				<hr />
				<h3>Status Overview</h3>
				<div id="status-chart" aria-hidden="false"></div>
				<div style="margin-top:10px;">
					<button id="clear-status-filter">Clear Filter</button>
				</div>

				<hr />
				<h3>WINS Overview</h3>
				<div id="wins-chart" aria-hidden="false"></div>
				<div style="margin-top:10px;">
					<button id="clear-wins-filter">Clear WINS Filter</button>
				</div>

				<hr />
				<h3>Age Overview (by Status)</h3>
				<div id="age-overview" aria-hidden="false"></div>
				<div style="margin-top:10px;">
					<button id="clear-age-filter">Clear Age Filter</button>
				</div>
			</aside>
		</div>
			</section>

			<!-- Inventory Tracker System (Placeholder) -->
			<section id="inventory-system" class="hidden">
				<div class="card">
					<h2>Inventory Tracker System</h2>
					<p class="muted">This module is under development.</p>
					<div style="padding: 2rem; text-align: center; background: #f9fbfd; border-radius: 8px; margin-top: 1rem;">
						<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
						<p style="margin-top: 1rem; color: #666;">Inventory features coming soon.</p>
					</div>
				</div>
			</section>
		</main>



<!-- Document details modal (opens from left sidebar) -->
		

			<script src="app.js"></script>

			<script>
				document.addEventListener('DOMContentLoaded', () => {
					const STORAGE_KEY = 'dms_docs_v1';
					
					function loadDocs() {
						try {
							const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
							return Array.isArray(d) ? d.filter(x => x && typeof x === 'object') : [];
						} catch (e) { return []; }
					}

					function aggregateCount(items, keyFn) {
						const map = {};
						items.forEach(it => {
							if (!it) return;
							const k = (keyFn(it) || 'Unknown').trim() || 'Unknown';
							map[k] = (map[k] || 0) + 1;
						});
						return map;
					}

					function handleChartClick(evt, elements, chart) {
						if (elements.length > 0) {
							const i = elements[0].index;
							const label = chart.data.labels[i];
							const searchBox = document.getElementById('search-control');
							if(searchBox){
								searchBox.value = label;
								if(typeof renderDocs === 'function') renderDocs(label);
								const results = document.getElementById('results');
								if(results) results.scrollIntoView({behavior: 'smooth'});
							}
						}
					}

					const docs = loadDocs();
					// Migration logic to match app behavior
					docs.forEach(d => {
						if(d && d.status === 'Received'){
							if(!d.adminStatus) d.adminStatus = 'Received';
							d.status = 'Routing';
						}
					});

					// Enhanced Chart Configuration
					Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif";
					Chart.defaults.color = '#858796';

					// 1. By Title (Pie)
					const byTitle = aggregateCount(docs, d => d.title);
					const sortedTitles = Object.entries(byTitle).sort((a,b) => b[1] - a[1]);
					const ctxTitle = document.getElementById('dash-pie-title');
					if (ctxTitle) {
						new Chart(ctxTitle, {
							type: 'pie',
							data: {
								labels: sortedTitles.map(e => e[0]),
								datasets: [{
									data: sortedTitles.map(e => e[1]),
									backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#5a5c69'],
									hoverOffset: 4,
									borderColor: '#ffffff',
									borderWidth: 2
								}]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: { title: { display: true, text: 'By Title' } },
								plugins: { 
									title: { display: true, text: 'Documents by Title', font: { size: 16, weight: 'bold' }, color: '#5a5c69' },
									legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 10 } }
								},
								onClick: handleChartClick
							}
						});
					}

					// 2. By Owner (Bar)
					const byOwner = aggregateCount(docs, d => d.owner);
					// Sort by count descending
					const sortedOwners = Object.entries(byOwner).sort((a,b) => b[1] - a[1]);
					const ctxOwner = document.getElementById('dash-bar-owner');
					if (ctxOwner) {
						new Chart(ctxOwner, {
							type: 'bar',
							data: {
								labels: sortedOwners.map(e => e[0]),
								datasets: [{
									label: 'Documents',
									data: sortedOwners.map(e => e[1]),
									backgroundColor: '#4e73df',
									borderRadius: 4,
									barPercentage: 0.6
								}]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: { title: { display: true, text: 'By Owner' }, legend: { display: false } },
								scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
								plugins: { 
									title: { display: true, text: 'Documents by Owner', font: { size: 16, weight: 'bold' }, color: '#5a5c69' }, 
									legend: { display: false } 
								},
								scales: { 
									y: { beginAtZero: true, ticks: { precision: 0 }, grid: { borderDash: [2], drawBorder: false, color: '#e3e6f0' } },
									x: { grid: { display: false, drawBorder: false } }
								},
								onClick: handleChartClick
							}
						});
					}

					// 3. By Week (Line)
					const byWeek = {};
					docs.forEach(d => {
						if (!d || !d.createdAt) return;
						let date = new Date(d.createdAt);
						if (isNaN(date.getTime())) date = new Date(Number(d.createdAt));
						if (isNaN(date.getTime())) return;
						
						const day = date.getDay();
						const diff = date.getDate() - day + (day === 0 ? -6 : 1);
						const monday = new Date(date);
						monday.setDate(diff);
						const key = monday.toISOString().split('T')[0];
						byWeek[key] = (byWeek[key] || 0) + 1;
					});
					const sortedWeeks = Object.keys(byWeek).sort();
					const ctxWeek = document.getElementById('dash-line-week');
					if (ctxWeek) {
						new Chart(ctxWeek, {
							type: 'line',
							data: {
								labels: sortedWeeks,
								datasets: [{
									label: 'New Documents',
									data: sortedWeeks.map(k => byWeek[k]),
									borderColor: '#36b9cc',
									backgroundColor: 'rgba(54, 185, 204, 0.1)',
									fill: true,
									tension: 0.4,
									pointRadius: 4,
									pointBackgroundColor: '#36b9cc',
									pointBorderColor: '#fff',
									pointHoverRadius: 6
								}]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: { title: { display: true, text: 'By Week Created' } },
								scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
								plugins: { 
									title: { display: true, text: 'Weekly Creation Trend', font: { size: 16, weight: 'bold' }, color: '#5a5c69' },
									legend: { display: false }
								},
								scales: { 
									y: { beginAtZero: true, ticks: { precision: 0 }, grid: { borderDash: [2], drawBorder: false, color: '#e3e6f0' } },
									x: { grid: { display: false, drawBorder: false } }
								},
								onClick: handleChartClick
							}
						});
					}

					// Ensure charts resize when sidebar is toggled
					const sidebarToggle = document.getElementById('sidebar-toggle');
					if(sidebarToggle){
						sidebarToggle.addEventListener('click', () => {
							setTimeout(() => {
								Object.values(Chart.instances).forEach(c => c.resize());
							}, 300);
						});
					}

					// Main Sidebar Toggle
					const mainSidebarToggle = document.getElementById('main-sidebar-toggle');
					if (mainSidebarToggle) {
						mainSidebarToggle.addEventListener('click', () => {
							document.body.classList.toggle('sidebar-collapsed');
							document.getElementById('app-sidebar').classList.toggle('collapsed');
							setTimeout(() => {
								Object.values(Chart.instances).forEach(c => c.resize());
							}, 300);
						});
					}
				});
			</script>
			<!-- profile moved to profile.html -->
	</body>
</html>

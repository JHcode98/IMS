<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Users Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .wrap{max-width:980px;margin:18px auto;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left}
    .muted{color:#666}
    button{padding:6px 8px;border-radius:6px;border:0;background:#2752a7;color:#fff}
  </style>
</head>
<body>
  <div class="wrap card">
    <h1>Users Dashboard</h1>
    <p class="muted">Admin-only view: list and manage registered users.</p>
    <div id="not-authorized" class="muted" style="display:none">Not authorized. Redirecting to login...</div>
    <table id="users-table">
      <thead>
        <tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:12px">
      <a href="index.html">Back to app</a>
    </div>
  </div>

  <script>
    const AUTH_ROLE_KEY = 'dms_auth_role_v1';
    const USERS_STORAGE_KEY = 'dms_users_v1';
    // Only allow admin
    const role = localStorage.getItem(AUTH_ROLE_KEY) || null;
    if(role !== 'admin'){
      document.getElementById('not-authorized').style.display = '';
      setTimeout(()=>{ window.location.href = 'index.html'; }, 1200);
    }

    function loadLocalUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '{}'); }catch(e){ return {}; } }
    function saveLocalUsers(u){ try{ localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(u)); }catch(e){} }

    // Try server first (if API reachable), otherwise fallback to localStorage
    async function fetchUsersFromServer(){
      try{
        const token = localStorage.getItem('dms_auth_token_v1') || '';
        const r = await fetch('/api/users', { headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
        if(!r.ok) return null;
        const j = await r.json();
        return j.users || null;
      }catch(e){ return null; }
    }

    async function render(){
      const t = document.querySelector('#users-table tbody'); t.innerHTML = '';
      const serverUsers = await fetchUsersFromServer();
      if(serverUsers){
        serverUsers.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.username}</td><td><select data-user="${u.username}"><option value="user" ${u.role==='user'?'selected':''}>User</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select></td><td>${u.createdAt?new Date(Number(u.createdAt)).toLocaleString():''}</td><td><button data-delete="${u.username}">Delete</button></td>`;
          t.appendChild(tr);
        });
        // wire server-side actions
        document.querySelectorAll('select[data-user]').forEach(s => s.addEventListener('change', async ev => {
          const uname = s.getAttribute('data-user');
          const token = localStorage.getItem('dms_auth_token_v1') || '';
          const newRole = s.value;
          const r = await fetch('/api/users/' + encodeURIComponent(uname), { method: 'PUT', headers: { 'Content-Type':'application/json', 'Authorization': token ? ('Bearer ' + token) : '' }, body: JSON.stringify({ role: newRole }) });
          if(!r.ok){ const j=await r.json().catch(()=>{}); alert((j && j.error) || 'Unable to update role'); render(); return; }
          alert('Role updated');
        }));
        document.querySelectorAll('button[data-delete]').forEach(b => b.addEventListener('click', async ev => {
          const uname = b.getAttribute('data-delete');
          if(!confirm('Delete user ' + uname + '?')) return;
          const token = localStorage.getItem('dms_auth_token_v1') || '';
          const r = await fetch('/api/users/' + encodeURIComponent(uname), { method: 'DELETE', headers: { 'Authorization': token ? ('Bearer ' + token) : '' } });
          if(!r.ok){ const j=await r.json().catch(()=>{}); alert((j && j.error) || 'Unable to delete'); return; }
          render();
        }));
        return;
      }

      // fallback to local
      const users = loadLocalUsers();
      const keys = Object.keys(users).sort();
      if(keys.length === 0){ t.innerHTML = '<tr><td colspan="4" class="muted">No users registered.</td></tr>'; return; }
      keys.forEach(k => {
        const u = users[k];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td><select data-user="${k}"><option value="user" ${u.role==='user'?'selected':''}>User</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select></td><td>${u.createdAt?new Date(Number(u.createdAt)).toLocaleString():''}</td><td><button data-delete="${k}">Delete</button></td>`;
        t.appendChild(tr);
      });
      // wire selects and deletes (local)
      document.querySelectorAll('select[data-user]').forEach(s => s.addEventListener('change', ev => {
        const uname = s.getAttribute('data-user');
        const users = loadLocalUsers();
        users[uname] = users[uname] || {}; users[uname].role = s.value; saveLocalUsers(users); alert('Role updated');
      }));
      document.querySelectorAll('button[data-delete]').forEach(b => b.addEventListener('click', ev => {
        const uname = b.getAttribute('data-delete');
        if(!confirm('Delete user ' + uname + '?')) return;
        const users = loadLocalUsers(); delete users[uname]; saveLocalUsers(users); render();
      }));
    }

    render();
  </script>
</body>
</html>

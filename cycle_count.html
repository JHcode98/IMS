<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cycle Count - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="inventory-mode">
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="window.location.href='index.html'" data-tooltip="Document Monitoring">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        <span class="menu-text">Document Monitoring</span>
      </button></li>
      <li>
        <button class="active" onclick="window.location.href='index.html'" data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
          <li><button class="active" onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
          <li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Cycle Count</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count_reports.html'">Reports</button>
        <button class="nav-btn" onclick="alert('Analytics Dashboard feature coming soon')">Analytics Dashboard</button>
      </div>
      <div class="nav-right">
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <button id="dark-mode-toggle" role="menuitem">Dark Mode</button>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card" id="form-card">
      <h2>New Cycle Count Entry</h2>
      <form id="cycle-count-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
        <div>
          <label for="item-code">Item Code / Name</label>
          <input type="text" id="item-code" required pattern="[15][0-9]{7}" title="8 digits starting with 1 or 5" inputmode="numeric" maxlength="8" style="width:100%">
        </div>
        <div>
          <label for="location">Location</label>
          <input type="text" id="location" required pattern=".{8}" title="Exactly 8 characters" maxlength="8" style="width:100%">
        </div>
        <div>
          <label for="system-qty">System Qty</label>
          <input type="number" id="system-qty" required style="width:100%">
        </div>
        <div>
          <label for="physical-qty">Physical Qty</label>
          <input type="number" id="physical-qty" required style="width:100%">
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="notes">Notes</label>
          <input type="text" id="notes" style="width:100%">
        </div>
        <div>
          <button type="submit">Add Entry</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top: 20px;">
      <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div style="display:flex; align-items:center; gap:8px">
          <h2>Cycle Count Records</h2>
          <button id="toggle-form-btn" class="icon-btn" title="Full View (Hide Form)" style="color:#666">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
          </button>
        </div>
        <div class="tools" style="display:flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <input type="text" id="search-item-code" placeholder="Search..." style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
          <select id="date-filter-type" style="padding: 7px; border-radius: 6px; border: 1px solid #ccc;">
            <option value="updated">Updated Date</option>
            <option value="created">Created Date</option>
          </select>
          <label for="start-date" style="font-size:13px;color:var(--muted);margin-left:8px;">From:</label>
          <input type="date" id="start-date" style="padding: 7px; border-radius: 6px; border: 1px solid #ccc;">
          <label for="end-date" style="font-size:13px;color:var(--muted)">To:</label>
          <input type="date" id="end-date" style="padding: 7px; border-radius: 6px; border: 1px solid #ccc;">
          <button id="filter-date-btn" class="icon-btn" title="Filter Date Range" style="margin-left: 4px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
          </button>
          <button id="clear-date-filter-btn" class="icon-btn" title="Clear Date Filter" style="margin-left:-4px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
          
          <button id="clear-all-filters-btn" class="icon-btn" title="Clear All Filters" style="margin-left: 4px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
          </button>
          <button id="delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; margin-left: 4px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
          </button>
          <button id="export-csv-btn" class="icon-btn" title="Export to CSV">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
          <button id="download-template-btn" class="icon-btn" title="Download Template">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="9 15 12 12 15 15"></polyline></svg>
          </button>
          <button id="import-csv-btn" class="icon-btn" title="Import CSV">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          </button>
          <input type="file" id="import-csv-file" accept=".csv" style="display: none;">
        </div>
      </div>
      <table id="cycle-count-table" style="width:100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
            <th style="padding: 8px; text-align: left; width: 40px;"><input type="checkbox" id="select-all-cc"></th>
            <th style="padding: 8px; text-align: left;">Updated Date</th>
            <th style="padding: 8px; text-align: left;">Created Date</th>
            <th style="padding: 8px; text-align: left;">Item</th>
            <th style="padding: 8px; text-align: left;">Location</th>
            <th style="padding: 8px; text-align: left;">System</th>
            <th style="padding: 8px; text-align: left;">Physical</th>
            <th style="padding: 8px; text-align: left; cursor:pointer; user-select:none" id="sort-variance-header" title="Click to sort by Variance">Variance <span id="sort-variance-icon" style="font-size:12px; color:#666"></span></th>
            <th style="padding: 8px; text-align: left;">Notes</th>
            <th style="padding: 8px; text-align: left;">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="pagination-controls" class="sidebar-pagination" style="margin-top: 10px; justify-content: flex-end;"></div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    if(!localStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';
    // Cycle Count Logic
    const form = document.getElementById('cycle-count-form');
    const tableBody = document.querySelector('#cycle-count-table tbody');
    const STORAGE_KEY_CC = 'ims_cycle_count_v1';
    const cycleCountSearchInput = document.getElementById('search-item-code');
    const exportBtn = document.getElementById('export-csv-btn');
    const ccDownloadTemplateBtn = document.getElementById('download-template-btn');
    const importBtn = document.getElementById('import-csv-btn');
    const ccImportFile = document.getElementById('import-csv-file');
    const selectAllCc = document.getElementById('select-all-cc');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const clearDateFilterBtn = document.getElementById('clear-date-filter-btn');
    const filterDateBtn = document.getElementById('filter-date-btn');
    const dateFilterType = document.getElementById('date-filter-type');
    const clearAllFiltersBtn = document.getElementById('clear-all-filters-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    
    let currentPage = 1;
    let rowsPerPage = 10;
    let sortField = null;
    let sortDirection = 'asc';

    function getCandidateDates(dateStr) {
      if (!dateStr) return [];
      const candidates = [];
      
      // 1. Standard parse (handles ISO, MM/DD/YYYY, etc.)
      let s = dateStr;
      // Fix ISO UTC issue: treat YYYY-MM-DD as local
      if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) s += 'T00:00:00';
      
      const d1 = new Date(s);
      if (!isNaN(d1.getTime())) candidates.push(d1);

      // 2. Try parsing as DD/MM/YYYY explicitly if it contains slashes
      if (typeof dateStr === 'string' && dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
           // Assume YYYY is last or first. 
           let d, m, y;
           if (parts[2].length === 4) { 
             y = parseInt(parts[2], 10);
             // Try DD/MM/YYYY
             m = parseInt(parts[1], 10); d = parseInt(parts[0], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
             // Try MM/DD/YYYY
             m = parseInt(parts[0], 10); d = parseInt(parts[1], 10);
             if (y && m && d) { const dt = new Date(y, m - 1, d); if (!isNaN(dt.getTime()) && dt.getDate() === d) candidates.push(dt); }
           }
           else if (parts[0].length === 4) { 
             y = parseInt(parts[0], 10); m = parseInt(parts[1], 10); d = parseInt(parts[2], 10); 
             if (y && m && d) {
               const d2 = new Date(y, m - 1, d); // Month is 0-indexed
               if (!isNaN(d2.getTime()) && d2.getDate() === d) candidates.push(d2);
             }
           }
        }
      }
      return candidates;
    }

    function normalizeDate(dateStr) {
      const candidates = getCandidateDates(dateStr);
      if (candidates.length > 0) return candidates[0].toISOString();
      return new Date().toISOString();
    }

    function loadData() {
      let data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
      // Add original index to handle deletion after filtering
      data = data.map((item, index) => ({ ...item, originalIndex: index }));
      
      const searchTerms = cycleCountSearchInput.value.toLowerCase().split(' ').filter(Boolean);
      let filteredData = data.filter(item => {
        if (searchTerms.length === 0) return true;
        const itemText = [item.itemCode, item.location, item.notes || ''].join(' ').toLowerCase();
        return searchTerms.every(term => itemText.includes(term));
      });

      // Date range filter
      let startDate = null;
      if (startDateInput.value) {
        const parts = startDateInput.value.split('-');
        startDate = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
      }
      let endDate = null;
      if (endDateInput.value) {
        const parts = endDateInput.value.split('-');
        endDate = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999);
      }
      const filterType = dateFilterType ? dateFilterType.value : 'updated';

      if (startDate) {
        filteredData = filteredData.filter(item => {
          const dateStr = filterType === 'created' ? item.createdDate : item.date;
          const dates = getCandidateDates(dateStr);
          return dates.some(d => d >= startDate);
        });
      }
      if (endDate) {
        filteredData = filteredData.filter(item => {
          const dateStr = filterType === 'created' ? item.createdDate : item.date;
          const dates = getCandidateDates(dateStr);
          return dates.some(d => d <= endDate);
        });
      }

      if (sortField === 'variance') {
        filteredData.sort((a, b) => {
          const varA = (a.physical || 0) - (a.system || 0);
          const varB = (b.physical || 0) - (b.system || 0);
          return sortDirection === 'asc' ? varA - varB : varB - varA;
        });
      }

      const totalRows = filteredData.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedData = filteredData.slice(start, end);

      renderTable(paginatedData);
      renderPagination(totalRows, totalPages);
    }

    function renderTable(data) {
      tableBody.innerHTML = '';
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="10" class="muted" style="text-align:center; padding: 20px;">No records found for your search.</td></tr>`;
        return;
      }
      data.forEach((item) => {
        const tr = document.createElement('tr');
        const variance = item.physical - item.system;
        let varianceClass = 'age-good'; // Zero variance (Green)
        if (variance < 0) varianceClass = 'age-bad'; // Negative (Red)
        else if (variance > 0) varianceClass = 'age-warn'; // Positive (Orange)
        
        const formatOrRaw = (val) => {
            if(!val) return '';
            // If it looks like a system ISO string, format it. Otherwise display raw.
            if(typeof val === 'string' && val.includes('T') && val.endsWith('Z') && !isNaN(new Date(val).getTime())) {
                return new Date(val).toLocaleString();
            }
            return val;
        };
        const timestamp = formatOrRaw(item.date);
        const createdDate = formatOrRaw(item.createdDate);
        
        tr.innerHTML = `
          <td style="padding:8px;border-bottom:1px solid #eee"><input type="checkbox" class="row-checkbox" data-index="${item.originalIndex}"></td>
          <td style="padding:8px;border-bottom:1px solid #eee">${timestamp}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">${createdDate}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">${item.itemCode}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">${item.location}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">${item.system}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">${item.physical}</td>
          <td style="padding:8px;border-bottom:1px solid #eee"><span class="age ${varianceClass}">${variance > 0 ? '+'+variance : variance}</span></td>
          <td style="padding:8px;border-bottom:1px solid #eee">${item.notes || ''}</td>
          <td style="padding:8px;border-bottom:1px solid #eee">
            <button class="icon-btn edit-btn" data-index="${item.originalIndex}" title="Edit" style="margin-right:4px">✎</button>
            <button class="icon-btn delete-btn" data-index="${item.originalIndex}" title="Delete" style="color:#d9534f">&times;</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const newItem = {
        itemCode: document.getElementById('item-code').value,
        location: document.getElementById('location').value,
        system: Number(document.getElementById('system-qty').value),
        physical: Number(document.getElementById('physical-qty').value),
        notes: document.getElementById('notes').value,
        date: new Date().toISOString(),
        createdDate: new Date().toISOString()
      };

      const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
      
      const editingIndex = form.dataset.editingIndex;
      if (editingIndex !== undefined) {
        // Update existing entry
        data[editingIndex] = { ...data[editingIndex], ...newItem };
        delete form.dataset.editingIndex;
        form.querySelector('button[type="submit"]').textContent = 'Add Entry';
      } else {
        // Add new entry
        data.unshift(newItem);
      }

      localStorage.setItem(STORAGE_KEY_CC, JSON.stringify(data));
      form.reset();
      loadData();
    });

    tableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        if(!confirm('Delete this entry?')) return;
        const originalIndex = e.target.dataset.index;
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
        data.splice(originalIndex, 1);
        localStorage.setItem(STORAGE_KEY_CC, JSON.stringify(data));
        loadData();
      }
      if (e.target.classList.contains('edit-btn')) {
        const originalIndex = e.target.dataset.index;
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
        const item = data[originalIndex];
        if(item){
          document.getElementById('item-code').value = item.itemCode;
          document.getElementById('location').value = item.location;
          document.getElementById('system-qty').value = item.system;
          document.getElementById('physical-qty').value = item.physical;
          document.getElementById('notes').value = item.notes || '';
          
          form.dataset.editingIndex = originalIndex;
          form.querySelector('button[type="submit"]').textContent = 'Update Entry';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
    });

    if(deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', () => {
        const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'));
        if(!selected.length) { alert('No items selected'); return; }
        if(!confirm(`Are you sure you want to delete ${selected.length} records?`)) return;
        
        const indices = selected.map(cb => parseInt(cb.dataset.index));
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
        const newData = data.filter((_, idx) => !indices.includes(idx));
        
        localStorage.setItem(STORAGE_KEY_CC, JSON.stringify(newData));
        loadData();
        if(selectAllCc) selectAllCc.checked = false;
      });
    }

    // Checkbox highlight logic
    tableBody.addEventListener('change', (e) => {
      if(e.target.classList.contains('row-checkbox')){
        const tr = e.target.closest('tr');
        if(e.target.checked) tr.classList.add('selected-row');
        else tr.classList.remove('selected-row');
      }
    });

    if(selectAllCc){
      selectAllCc.addEventListener('change', () => {
        const checkboxes = tableBody.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = selectAllCc.checked;
          const tr = cb.closest('tr');
          if(cb.checked) tr.classList.add('selected-row');
          else tr.classList.remove('selected-row');
        });
      });
    }

    function renderPagination(totalRows, totalPages) {
      const paginationContainer = document.getElementById('pagination-controls');
      if (!paginationContainer) return;

      if (totalRows <= rowsPerPage) {
        paginationContainer.innerHTML = '';
        return;
      }

      paginationContainer.innerHTML = `
        <button id="prev-page-btn" class="icon-btn" title="Previous Page">‹</button>
        <span class="current-page" style="padding: 0 10px;">Page ${currentPage} of ${totalPages}</span>
        <button id="next-page-btn" class="icon-btn" title="Next Page">›</button>
      `;

      const prevBtn = document.getElementById('prev-page-btn');
      const nextBtn = document.getElementById('next-page-btn');

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      prevBtn.onclick = () => {
        if (currentPage > 1) { currentPage--; loadData(); }
      };

      nextBtn.onclick = () => {
        if (currentPage < totalPages) { currentPage++; loadData(); }
      };
    }

    function exportToCSV() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
      if (data.length === 0) {
        alert('No data to export.');
        return;
      }

      const headers = ['Updated Date', 'Created Date', 'Item Code', 'Location', 'System Qty', 'Physical Qty', 'Variance', 'Notes'];
      const csvRows = [headers.join(',')];

      const csvEscape = (field) => {
        if (field == null) return '""';
        const s = String(field);
        if (/[,"\n]/.test(s)) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return '"' + s + '"';
      };

      data.forEach(item => {
        const variance = item.physical - item.system;
        const timestamp = new Date(item.date).toLocaleString();
        const createdDate = item.createdDate ? new Date(item.createdDate).toLocaleString() : '';
        const row = [
          timestamp, createdDate, item.itemCode, item.location, item.system, item.physical, variance, item.notes || ''
        ];
        csvRows.push(row.map(csvEscape).join(','));
      });

      const csvString = csvRows.join('\n');
      const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cycle_count_export.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadTemplate() {
      const headers = ['Created Date', 'Updated Date', 'Item Code', 'Location', 'System Qty', 'Physical Qty', 'Notes'];
      const sample = [new Date().toISOString(), new Date().toISOString(), '10000001', '12345678', '10', '8', 'Sample Note'];
      const csvContent = headers.join(',') + '\n' + sample.join(',');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cycle_count_template.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    exportBtn.addEventListener('click', exportToCSV);
    if(ccDownloadTemplateBtn) ccDownloadTemplateBtn.addEventListener('click', downloadTemplate);

    importBtn.addEventListener('click', () => ccImportFile.click());

    ccImportFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const csv = event.target.result;
          const lines = csv.split(/\r\n|\n/);
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          
          const requiredHeaders = ['Item Code', 'Location', 'System Qty', 'Physical Qty'];
          if (!requiredHeaders.every(h => headers.includes(h))) {
            alert(`Import failed: CSV must contain headers: ${requiredHeaders.join(', ')}.`);
            return;
          }

          const data = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');
          let addedCount = 0;
          let duplicateCount = 0;

          for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            
            let createdDateVal = new Date().toISOString();
            let updatedDateVal = new Date().toISOString();

            // 1. Resolve Created Date (Prioritize 'Created Date', then 'Date', then 'Timestamp')
            let cIdx = headers.indexOf('Created Date');
            if (cIdx === -1) cIdx = headers.indexOf('Date');
            if (cIdx === -1) cIdx = headers.indexOf('Timestamp');
            
            if (cIdx !== -1 && values[cIdx]) {
                // Use raw value from file to preserve format
                createdDateVal = normalizeDate(values[cIdx]);
                updatedDateVal = createdDateVal;
            }

            // 2. Resolve Updated Date (override if explicit)
            const uIdx = headers.indexOf('Updated Date');
            if (uIdx !== -1 && values[uIdx]) {
                 updatedDateVal = normalizeDate(values[uIdx]);
            }

            const newItem = {
              itemCode: values[headers.indexOf('Item Code')],
              location: values[headers.indexOf('Location')],
              system: Number(values[headers.indexOf('System Qty')]),
              physical: Number(values[headers.indexOf('Physical Qty')]),
              notes: headers.includes('Notes') ? values[headers.indexOf('Notes')] : '',
              date: updatedDateVal,
              createdDate: createdDateVal
            };
            // Validate Item Code (exactly 8 digits)
            if (newItem.itemCode && /^\d{8}$/.test(newItem.itemCode) && !isNaN(newItem.system) && !isNaN(newItem.physical)) {
              // Check for duplicates (Item Code + Location + Created Date)
              const exists = data.some(d => d.itemCode === newItem.itemCode && d.location === newItem.location && d.createdDate === newItem.createdDate);
              if (exists) {
                duplicateCount++;
              } else {
                data.unshift(newItem);
                addedCount++;
              }
            }
          }
          if (addedCount > 0 || duplicateCount > 0) {
            localStorage.setItem(STORAGE_KEY_CC, JSON.stringify(data));
            let msg = `${addedCount} entries imported successfully.`;
            if (duplicateCount > 0) msg += ` ${duplicateCount} duplicates skipped.`;
            alert(msg);
            loadData();
          } else {
            alert('No valid entries found to import.');
          }
        } catch (error) {
          console.error('Import error:', error);
          alert('Failed to import CSV file. Please check the file format.');
        } finally {
          ccImportFile.value = '';
        }
      };
      reader.readAsText(file);
    });

    // Event Listeners
    cycleCountSearchInput.addEventListener('input', loadData);
    if(filterDateBtn) filterDateBtn.addEventListener('click', loadData);
    clearDateFilterBtn.addEventListener('click', () => {
        startDateInput.value = '';
        endDateInput.value = '';
        loadData();
    });
    if(clearAllFiltersBtn) {
      clearAllFiltersBtn.addEventListener('click', () => {
        cycleCountSearchInput.value = '';
        startDateInput.value = '';
        endDateInput.value = '';
        loadData();
      });
    }

    loadData();

    // Sidebar Toggle Logic
    const mainSidebarToggle = document.getElementById('main-sidebar-toggle');
    if (mainSidebarToggle) {
      mainSidebarToggle.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-collapsed');
        document.getElementById('app-sidebar').classList.toggle('collapsed');
      });
    }

    // Sort Variance Logic
    const sortVarianceHeader = document.getElementById('sort-variance-header');
    if(sortVarianceHeader){
      sortVarianceHeader.addEventListener('click', () => {
        if(sortField === 'variance'){
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = 'variance';
          sortDirection = 'asc';
        }
        document.getElementById('sort-variance-icon').textContent = sortDirection === 'asc' ? '↑' : '↓';
        loadData();
      });
    }

    // Toggle Form Logic
    const toggleFormBtn = document.getElementById('toggle-form-btn');
    const formCard = document.getElementById('form-card');
    if(toggleFormBtn && formCard){
      toggleFormBtn.addEventListener('click', () => {
        const isHidden = formCard.classList.toggle('hidden');
        toggleFormBtn.title = isHidden ? "Show Form" : "Full View (Hide Form)";
        // Change icon based on state
        toggleFormBtn.innerHTML = isHidden ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
      });
    }
  </script>
</body>
</html>
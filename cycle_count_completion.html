<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cycle Count Completion - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .summary-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; border: 1px solid #eef2f6; }
    .summary-value { font-size: 2.5em; font-weight: bold; color: #2752a7; margin-bottom: 5px; }
    .summary-label { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
    .progress-container { background: #e9ecef; border-radius: 8px; height: 30px; width: 100%; overflow: hidden; margin-bottom: 10px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
    #completion-bar { height: 100%; width: 0%; transition: width 0.5s ease, background-color 0.3s ease; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 14px; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="inventory-mode">
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="window.location.href='index.html'" data-tooltip="Document Monitoring">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        <span class="menu-text">Document Monitoring</span>
      </button></li>
      <li>
        <button class="active" onclick="window.location.href='index.html'" data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
          <li><button onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
          <li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
          <li><button class="active" onclick="window.location.href='cycle_count_completion.html'">Cycle Count Completion</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Cycle Count Completion</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count.html'">Back to Entry</button>
      </div>
      <div class="nav-right">
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Completion Status</h2>
      <p class="muted">This module will track the completion progress of cycle counts against the master inventory list.</p>
      
      <!-- Master List Section -->
      <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #eef2f6; margin-top: 15px;">
        <h3>1. Master SKU List</h3>
        <p class="muted">Upload a CSV file containing the full list of Item Codes to track progress against.</p>
        <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap: wrap;">
          <input type="file" id="master-list-file" accept=".csv" style="padding: 6px; background: #fff;">
          <button id="upload-master-btn">Upload Master List</button>
          <button id="clear-master-btn" style="background:#d9534f; color: white;">Clear Master List</button>
        </div>
        <p id="master-status" style="margin-top:10px; font-weight:bold; color:#2752a7"></p>
      </div>

      <!-- Progress Section -->
      <div style="margin-bottom: 20px;">
        <h3>2. Completion Progress</h3>
        <div class="progress-container">
          <div id="completion-bar">0%</div>
        </div>
        
        <div class="report-grid">
          <div class="summary-card">
            <div class="summary-value" id="stat-total-master">0</div>
            <div class="summary-label">Total Master SKUs</div>
          </div>
          <div class="summary-card">
            <div class="summary-value" id="stat-counted">0</div>
            <div class="summary-label">Unique SKUs Counted</div>
          </div>
          <div class="summary-card">
            <div class="summary-value" id="stat-remaining">0</div>
            <div class="summary-label">Remaining SKUs</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    if(!localStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';
    
    // Sidebar Toggle Logic
    const mainSidebarToggle = document.getElementById('main-sidebar-toggle');
    if (mainSidebarToggle) {
      mainSidebarToggle.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-collapsed');
        document.getElementById('app-sidebar').classList.toggle('collapsed');
      });
    }

    const STORAGE_KEY_CC = 'ims_cycle_count_v1';
    const STORAGE_KEY_MASTER = 'ims_master_sku_list_v1';

    function loadCompletionData() {
        const masterList = JSON.parse(localStorage.getItem(STORAGE_KEY_MASTER) || '[]');
        const cycleData = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]');

        // Get unique item codes from cycle count
        const countedSet = new Set(cycleData.map(item => String(item.itemCode).trim()));
        
        // Calculate stats
        const totalMaster = masterList.length;
        let countedFromMaster = 0;
        
        if (totalMaster > 0) {
            // Count how many master items are in the counted set
            countedFromMaster = masterList.filter(sku => countedSet.has(String(sku).trim())).length;
        }

        const percentage = totalMaster > 0 ? ((countedFromMaster / totalMaster) * 100).toFixed(1) : 0;
        const remaining = totalMaster - countedFromMaster;

        // Update UI
        document.getElementById('stat-total-master').textContent = totalMaster;
        document.getElementById('stat-counted').textContent = countedFromMaster;
        document.getElementById('stat-remaining').textContent = remaining;

        const bar = document.getElementById('completion-bar');
        bar.style.width = percentage + '%';
        bar.textContent = percentage + '%';
        
        // Color coding based on percentage
        if(percentage < 30) bar.style.backgroundColor = '#e74c3c'; // Red
        else if(percentage < 70) bar.style.backgroundColor = '#f1c40f'; // Yellow
        else bar.style.backgroundColor = '#2ecc71'; // Green

        const statusText = document.getElementById('master-status');
        if(totalMaster === 0) {
            statusText.textContent = 'No Master List loaded.';
            statusText.style.color = '#e74c3c';
        } else {
            statusText.textContent = `Master List Loaded: ${totalMaster} items.`;
            statusText.style.color = '#2752a7';
        }
    }

    // Upload Handler
    document.getElementById('upload-master-btn').addEventListener('click', () => {
        const fileInput = document.getElementById('master-list-file');
        const file = fileInput.files[0];
        if(!file) { alert('Please select a CSV file first.'); return; }

        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split(/\r\n|\n/);
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            let colIdx = headers.indexOf('Item Code');
            if(colIdx === -1) colIdx = 0; // Default to first column

            const newMaster = [];
            for(let i=1; i<lines.length; i++) {
                if(!lines[i].trim()) continue;
                const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                if(cols[colIdx]) newMaster.push(cols[colIdx]);
            }

            // Unique master items
            const uniqueMaster = [...new Set(newMaster)];
            localStorage.setItem(STORAGE_KEY_MASTER, JSON.stringify(uniqueMaster));
            alert(`Master list uploaded successfully. ${uniqueMaster.length} unique items found.`);
            loadCompletionData();
            fileInput.value = '';
        };
        reader.readAsText(file);
    });

    document.getElementById('clear-master-btn').addEventListener('click', () => {
        if(confirm('Clear the master SKU list?')) {
            localStorage.removeItem(STORAGE_KEY_MASTER);
            loadCompletionData();
        }
    });

    loadCompletionData();
  </script>
</body>
</html>
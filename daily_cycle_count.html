<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Cycle Counters - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    .completion-high { color: #2ecc71; font-weight: bold; }
    .completion-med { color: #f1c40f; font-weight: bold; }
    .completion-low { color: #e74c3c; font-weight: bold; }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Reuse existing sidebar structure -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="window.location.href='homepage.html'"><span class="menu-text">Homepage</span></button></li>
      <li><button onclick="window.location.href='cycle_count.html'" class="active"><span class="menu-text">Inventory Tracker</span></button></li>
    </ul>
  </nav>

  <header>
    <h1>Daily Cycle Counters</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count.html'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:5px;vertical-align:text-bottom;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back to Cycle Count
        </button>
      </div>
      <div class="nav-right">
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn"><span id="username-display"></span></button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">Manage Daily Counters</h2>
        <div style="display:flex; gap:5px;">
            <button id="export-counters-btn" class="icon-btn" title="Export CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="archive-btn" class="icon-btn" title="Archive (Past Days)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
            </button>
        </div>
      </div>

      <!-- Form -->
      <form id="daily-counters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eef2f6;">
          <input type="hidden" id="counter-edit-id">
          <div>
              <label for="counter-date">Date</label>
              <input type="date" id="counter-date" required style="width:100%">
          </div>
          <div>
              <label for="counter-shift">Shift</label>
              <select id="counter-shift" required style="width:100%">
                  <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                  <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                  <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
              </select>
          </div>
          <div>
              <label for="counter-required">Required Counters</label>
              <input type="number" id="counter-required" required min="1" style="width:100%">
          </div>
          <div style="display:flex; gap:5px;">
              <button type="submit" id="save-counter-btn" class="icon-btn" title="Save" style="background: #2752a7; color: white; height: 38px; width: 100%; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save
              </button>
              <button type="button" id="cancel-counter-edit-btn" class="icon-btn" title="Cancel Edit" style="background: #6c757d; color: white; height: 38px; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
          </div>
      </form>

      <!-- Table -->
      <div style="overflow-x: auto;">
          <table id="daily-counters-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">1st Shift (6am-2pm)</th>
                      <th style="padding: 12px; text-align: left;">2nd Shift (2pm-10pm)</th>
                      <th style="padding: 12px; text-align: left;">3rd Shift (10pm-6am)</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">Attendance Sheet</h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="att-search" placeholder="Search name..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="add-att-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Entry
            </button>
        </div>
      </div>
      <div style="overflow-x: auto;">
          <table id="attendance-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">Shift</th>
                      <th style="padding: 12px; text-align: left;">Name</th>
                      <th style="padding: 12px; text-align: left;">Role</th>
                      <th style="padding: 12px; text-align: left;">Area</th>
                      <th style="padding: 12px; text-align: left;">Break Out</th>
                      <th style="padding: 12px; text-align: left;">Break In</th>
                      <th style="padding: 12px; text-align: left;">Duration</th>
                      <th style="padding: 12px; text-align: left;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
      <div id="att-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="att-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="att-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
        <span id="att-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="att-prev-page" class="icon-btn" title="Previous">‹</button>
            <button id="att-next-page" class="icon-btn" title="Next">›</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Attendance Modal -->
  <div id="att-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="att-modal-title">Add Attendance</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <form id="att-modal-form" style="display: grid; gap: 15px;">
            <input type="hidden" id="att-edit-id">
            <div>
                <label for="att-date">Date</label>
                <input type="date" id="att-date" required style="width:100%">
            </div>
            <div>
                <label for="att-shift">Shift</label>
                <select id="att-shift" required style="width:100%">
                    <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                    <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                    <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
                </select>
            </div>
            <div>
                <label for="att-name">Counter Name</label>
                <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%">
            </div>
            <div>
                <label for="att-role">Role</label>
                <select id="att-role" style="width:100%">
                    <option value="IC Support">IC Support</option>
                    <option value="IC Back up">IC Back up</option>
                </select>
            </div>
            <div>
                <label for="att-area">Area</label>
                <select id="att-area" style="width:100%">
                    <option value="Pick Bin">Pick Bin</option>
                    <option value="Reserved Bin">Reserved Bin</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-break-out">Break Out</label>
                    <input type="time" id="att-break-out" style="width:100%">
                </div>
                <div>
                    <label for="att-break-in">Break In</label>
                    <input type="time" id="att-break-in" style="width:100%">
                </div>
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button type="button" class="icon-btn close-modal" style="margin-right:5px;">Cancel</button>
                <button type="submit" class="icon-btn" style="background: #2752a7; color: white;">Save</button>
            </div>
        </form>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        const countersForm = document.getElementById('daily-counters-form');
        const countersTableBody = document.querySelector('#daily-counters-table tbody');
        const cancelCounterEditBtn = document.getElementById('cancel-counter-edit-btn');
        const saveCounterBtn = document.getElementById('save-counter-btn');
        const archiveBtn = document.getElementById('archive-btn');
        const exportCountersBtn = document.getElementById('export-counters-btn');
        const dateInput = document.getElementById('counter-date');
        
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        
        // Modal elements
        const attModal = document.getElementById('att-modal');
        const attForm = document.getElementById('att-modal-form');
        const addAttBtn = document.getElementById('add-att-btn');
        const attSearchInput = document.getElementById('att-search');

        const STORAGE_KEY_COUNTERS = 'ims_daily_counters_v1';
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        
        let showArchiveOnly = false;
        let attCurrentPage = 1;
        let attItemsPerPage = 20;

        // Set default date
        if(dateInput) dateInput.valueAsDate = new Date();

        function getCountersData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '[]');
            } catch (e) {
                console.error('Error parsing daily counters data', e);
                return [];
            }
        }

        function saveCountersData(data) {
            localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(data));
        }

        function getAttendanceData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }

        function renderCountersTable() {
            if (!countersTableBody) return;
            let data = getCountersData();
            const attendance = getAttendanceData();
            
            if (showArchiveOnly) {
                const today = new Date().toISOString().split('T')[0];
                data = data.filter(d => d.date < today);
            }
            
            // Group by Date
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.date]) grouped[item.date] = {};
                grouped[item.date][item.shift] = item;
            });
            
            const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            countersTableBody.innerHTML = '';
            if (dates.length === 0) {
                countersTableBody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding: 20px;">No daily counter records found.</td></tr>`;
                return;
            }
            
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            
            dates.forEach(date => {
                const tr = document.createElement('tr');
                let html = `<td style="padding:12px;border-bottom:1px solid #eee; font-weight:bold;">${date}</td>`;
                
                shifts.forEach(shift => {
                    const item = grouped[date][shift];
                    if (item) {
                        const req = Number(item.required) || 1;
                        const act = attendance.filter(a => a.date === item.date && a.shift === item.shift).length;
                        const pct = Math.round((act / req) * 100);
                        let pctClass = 'completion-low';
                        if(pct >= 100) pctClass = 'completion-high';
                        else if(pct >= 80) pctClass = 'completion-med';
                        
                        html += `
                        <td style="padding:12px;border-bottom:1px solid #eee; vertical-align:top;">
                            <div style="font-size:13px;">Req: <strong>${req}</strong> | Act: <strong>${act}</strong></div>
                            <div class="${pctClass}" style="margin-top:4px;">${pct}% Completed</div>
                            <div style="margin-top:6px;">
                                <button class="icon-btn edit-counter-btn" data-id="${item.id}" title="Edit" style="padding:2px 6px; font-size:12px;">✎</button>
                                <button class="icon-btn delete-counter-btn" data-id="${item.id}" title="Delete" style="padding:2px 6px; font-size:12px; color:#d9534f;">&times;</button>
                            </div>
                        </td>`;
                    } else {
                        html += `<td style="padding:12px;border-bottom:1px solid #eee; color:#ccc;">-</td>`;
                    }
                });
                tr.innerHTML = html;
                countersTableBody.appendChild(tr);
            });
        }

        if (exportCountersBtn) {
            exportCountersBtn.addEventListener('click', () => {
                const counters = getCountersData();
                const attendance = getAttendanceData();
                
                if (counters.length === 0) {
                    alert('No data to export.');
                    return;
                }

                // Sort by date desc, then shift
                counters.sort((a, b) => {
                    if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                const headers = ['Date', 'Shift', 'Required', 'Active', 'Completion %'];
                const rows = [headers.join(',')];

                counters.forEach(item => {
                    const req = Number(item.required) || 1;
                    const act = attendance.filter(a => a.date === item.date && a.shift === item.shift).length;
                    const pct = Math.round((act / req) * 100);
                    
                    rows.push([
                        item.date,
                        `"${item.shift}"`,
                        req,
                        act,
                        `${pct}%`
                    ].join(','));
                });

                const csvContent = rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'daily_counters_summary.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if (archiveBtn) {
            archiveBtn.addEventListener('click', () => {
                showArchiveOnly = !showArchiveOnly;
                archiveBtn.classList.toggle('active-filter', showArchiveOnly);
                renderCountersTable();
            });
        }

        function getDuration(start, end) {
            if (!start || !end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (minutes < 0) minutes += 24 * 60;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return (h > 0 ? h + 'h ' : '') + m + 'm';
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) attItemsPerPage = parseInt(attRowsPerPageSelect.value, 10);

            let data = getAttendanceData().sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const searchTerm = attSearchInput ? attSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                data = data.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.role && item.role.toLowerCase().includes(searchTerm)) ||
                    (item.area && item.area.toLowerCase().includes(searchTerm))
                );
            }

            // Pagination
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / attItemsPerPage) || 1;
            if (attCurrentPage > totalPages) attCurrentPage = totalPages;

            const paginatedData = data.slice((attCurrentPage - 1) * attItemsPerPage, attCurrentPage * attItemsPerPage);

            attendanceTableBody.innerHTML = '';
            const paginationControls = document.getElementById('att-pagination-controls');
            if (paginationControls) {
                if (totalItems <= attItemsPerPage) {
                    paginationControls.style.display = 'none';
                } else {
                    paginationControls.style.display = 'flex';
                    document.getElementById('att-page-info').textContent = `Page ${attCurrentPage} of ${totalPages} (${totalItems} records)`;
                    document.getElementById('att-prev-page').disabled = attCurrentPage <= 1;
                    document.getElementById('att-next-page').disabled = attCurrentPage >= totalPages;
                }
            }

            if (paginatedData.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="9" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.date}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.shift}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.name}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.role || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.area || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakOut || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakIn || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee; font-weight:bold; color:#555;">${getDuration(item.breakIn, item.breakOut)}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">
                        <button class="icon-btn edit-att-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">✎</button>
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
        }

        if (attSearchInput) {
            attSearchInput.addEventListener('input', () => {
                attCurrentPage = 1;
                renderAttendanceTable();
            });
        }

        const attPaginationControls = document.getElementById('att-pagination-controls');
        if (attPaginationControls) {
            attPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'att-prev-page' && !e.target.disabled) {
                    attCurrentPage--;
                    renderAttendanceTable();
                } else if (e.target.id === 'att-next-page' && !e.target.disabled) {
                    attCurrentPage++;
                    renderAttendanceTable();
                }
            });
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) {
                attRowsPerPageSelect.addEventListener('change', () => {
                    attCurrentPage = 1;
                    renderAttendanceTable();
                });
            }
        }

        if (countersForm) {
            countersForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('counter-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('counter-date').value,
                    shift: document.getElementById('counter-shift').value,
                    required: Number(document.getElementById('counter-required').value),
                    // active is now derived
                };

                let data = getCountersData();
                if (editId) {
                    const index = data.findIndex(item => item.id === editId);
                    if (index > -1) data[index] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveCountersData(data);
                renderCountersTable();
                
                // Reset form but keep date
                const currentDate = document.getElementById('counter-date').value;
                countersForm.reset();
                document.getElementById('counter-date').value = currentDate;
                
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
            });
        }

        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-counter-btn')) {
                    if(confirm('Delete this record?')) {
                        let data = getCountersData();
                        data = data.filter(item => item.id !== id);
                        saveCountersData(data);
                        renderCountersTable();
                    }
                } else if (btn.classList.contains('edit-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('counter-edit-id').value = item.id;
                        document.getElementById('counter-date').value = item.date;
                        document.getElementById('counter-shift').value = item.shift;
                        document.getElementById('counter-required').value = item.required;
                        
                        saveCounterBtn.innerHTML = 'Update';
                        cancelCounterEditBtn.style.display = 'inline-flex';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            });
        }

        if (cancelCounterEditBtn) {
            cancelCounterEditBtn.addEventListener('click', () => {
                countersForm.reset();
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
                document.getElementById('counter-date').valueAsDate = new Date();
            });
        }

        // Attendance Modal Logic
        if (addAttBtn) {
            addAttBtn.addEventListener('click', () => {
                document.getElementById('att-modal-title').textContent = 'Add Attendance';
                attForm.reset();
                document.getElementById('att-edit-id').value = '';
                document.getElementById('att-date').valueAsDate = new Date();
                attModal.classList.remove('hidden');
            });
        }

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => attModal.classList.add('hidden'));
        });

        if (attForm) {
            attForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('att-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    name: document.getElementById('att-name').value.trim(),
                    role: document.getElementById('att-role').value,
                    area: document.getElementById('att-area').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value
                };
                if(!newEntry.name) return;

                let data = getAttendanceData();
                if (editId) {
                    const idx = data.findIndex(x => x.id === editId);
                    if (idx > -1) data[idx] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveAttendanceData(data);
                
                attModal.classList.add('hidden');
                renderAttendanceTable();
                renderCountersTable(); // Update counts
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-att-btn')) {
                    if(confirm('Remove this person?')) {
                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        renderCountersTable(); // Update counts
                    }
                } else if (btn.classList.contains('edit-att-btn')) {
                    const data = getAttendanceData();
                    const item = data.find(x => x.id === id);
                    if (item) {
                        document.getElementById('att-modal-title').textContent = 'Edit Attendance';
                        document.getElementById('att-edit-id').value = item.id;
                        document.getElementById('att-date').value = item.date;
                        document.getElementById('att-shift').value = item.shift;
                        document.getElementById('att-name').value = item.name;
                        document.getElementById('att-role').value = item.role;
                        document.getElementById('att-area').value = item.area;
                        document.getElementById('att-break-out').value = item.breakOut;
                        document.getElementById('att-break-in').value = item.breakIn;
                        attModal.classList.remove('hidden');
                    }
                }
            });
        }

        renderCountersTable();
        renderAttendanceTable();
    });
  </script>
</body>
</html>
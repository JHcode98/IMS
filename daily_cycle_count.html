<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Cycle Counters - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    .completion-high { color: #2ecc71; font-weight: bold; }
    .completion-med { color: #f1c40f; font-weight: bold; }
    .completion-low { color: #e74c3c; font-weight: bold; }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Reuse existing sidebar structure -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="window.location.href='homepage.html'"><span class="menu-text">Homepage</span></button></li>
      <li><button onclick="window.location.href='cycle_count.html'" class="active"><span class="menu-text">Inventory Tracker</span></button></li>
    </ul>
  </nav>

  <header>
    <h1>Daily Cycle Counters</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count.html'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:5px;vertical-align:text-bottom;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back to Cycle Count
        </button>
      </div>
      <div class="nav-right">
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn"><span id="username-display"></span></button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">Manage Daily Counters</h2>
        <button id="archive-btn" class="icon-btn" title="Archive (Past Days)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
        </button>
      </div>

      <!-- Form -->
      <form id="daily-counters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eef2f6;">
          <input type="hidden" id="counter-edit-id">
          <div>
              <label for="counter-date">Date</label>
              <input type="date" id="counter-date" required style="width:100%">
          </div>
          <div>
              <label for="counter-shift">Shift</label>
              <select id="counter-shift" required style="width:100%">
                  <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                  <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                  <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
              </select>
          </div>
          <div>
              <label for="counter-required">Required Counters</label>
              <input type="number" id="counter-required" required min="1" style="width:100%">
          </div>
          <div style="display:flex; gap:5px;">
              <button type="submit" id="save-counter-btn" class="icon-btn" title="Save" style="background: #2752a7; color: white; height: 38px; width: 100%; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save
              </button>
              <button type="button" id="cancel-counter-edit-btn" class="icon-btn" title="Cancel Edit" style="background: #6c757d; color: white; height: 38px; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
          </div>
      </form>

      <!-- Table -->
      <div style="overflow-x: auto;">
          <table id="daily-counters-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">Shift</th>
                      <th style="padding: 12px; text-align: left;">Required Counters</th>
                      <th style="padding: 12px; text-align: left;">Active Counters</th>
                      <th style="padding: 12px; text-align: left;">Completion %</th>
                      <th style="padding: 12px; text-align: left;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">Attendance Sheet</h2>
      </div>
      <form id="attendance-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eef2f6;">
          <div>
              <label for="att-date">Date</label>
              <input type="date" id="att-date" required style="width:100%">
          </div>
          <div>
              <label for="att-shift">Shift</label>
              <select id="att-shift" required style="width:100%">
                  <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                  <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                  <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
              </select>
          </div>
          <div>
              <label for="att-name">Counter Name</label>
              <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%">
          </div>
          <div>
              <label for="att-role">Role</label>
              <select id="att-role" style="width:100%">
                  <option value="IC Support">IC Support</option>
                  <option value="IC Back up">IC Back up</option>
              </select>
          </div>
          <div>
              <label for="att-area">Area</label>
              <select id="att-area" style="width:100%">
                  <option value="Pick Bin">Pick Bin</option>
                  <option value="Reserved Bin">Reserved Bin</option>
              </select>
          </div>
          <div>
              <label for="att-break-in">Break In</label>
              <input type="time" id="att-break-in" style="width:100%">
          </div>
          <div>
              <label for="att-break-out">Break Out</label>
              <input type="time" id="att-break-out" style="width:100%">
          </div>
          <div>
              <button type="submit" class="icon-btn" style="background: #2752a7; color: white; height: 38px; width: 100%; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg> Add
              </button>
          </div>
      </form>
      <div style="overflow-x: auto;">
          <table id="attendance-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">Shift</th>
                      <th style="padding: 12px; text-align: left;">Name</th>
                      <th style="padding: 12px; text-align: left;">Role</th>
                      <th style="padding: 12px; text-align: left;">Area</th>
                      <th style="padding: 12px; text-align: left;">Break In</th>
                      <th style="padding: 12px; text-align: left;">Break Out</th>
                      <th style="padding: 12px; text-align: left;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        const countersForm = document.getElementById('daily-counters-form');
        const countersTableBody = document.querySelector('#daily-counters-table tbody');
        const cancelCounterEditBtn = document.getElementById('cancel-counter-edit-btn');
        const saveCounterBtn = document.getElementById('save-counter-btn');
        const archiveBtn = document.getElementById('archive-btn');
        const dateInput = document.getElementById('counter-date');
        
        const attendanceForm = document.getElementById('attendance-form');
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        const attDateInput = document.getElementById('att-date');

        const STORAGE_KEY_COUNTERS = 'ims_daily_counters_v1';
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        
        let showArchiveOnly = false;

        // Set default date
        if(dateInput) dateInput.valueAsDate = new Date();
        if(attDateInput) attDateInput.valueAsDate = new Date();

        function getCountersData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '[]');
            } catch (e) {
                console.error('Error parsing daily counters data', e);
                return [];
            }
        }

        function saveCountersData(data) {
            localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(data));
        }

        function getAttendanceData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }

        function renderCountersTable() {
            if (!countersTableBody) return;
            let data = getCountersData().sort((a, b) => new Date(b.date) - new Date(a.date));
            const attendance = getAttendanceData();
            
            if (showArchiveOnly) {
                const today = new Date().toISOString().split('T')[0];
                data = data.filter(d => d.date < today);
            }

            countersTableBody.innerHTML = '';
            if (data.length === 0) {
                countersTableBody.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center; padding: 20px;">No daily counter records found.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const tr = document.createElement('tr');
                const req = Number(item.required) || 1;
                
                // Calculate active from attendance
                const act = attendance.filter(a => a.date === item.date && a.shift === item.shift).length;
                
                const pct = Math.round((act / req) * 100);
                
                let pctClass = 'completion-low';
                if(pct >= 100) pctClass = 'completion-high';
                else if(pct >= 80) pctClass = 'completion-med';

                tr.innerHTML = `
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.date}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.shift}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.required}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${act}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee"><span class="${pctClass}">${pct}%</span></td>
                    <td style="padding:12px;border-bottom:1px solid #eee">
                        <button class="icon-btn edit-counter-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">âœŽ</button>
                        <button class="icon-btn delete-counter-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                countersTableBody.appendChild(tr);
            });
        }

        if (archiveBtn) {
            archiveBtn.addEventListener('click', () => {
                showArchiveOnly = !showArchiveOnly;
                archiveBtn.classList.toggle('active-filter', showArchiveOnly);
                renderCountersTable();
            });
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const data = getAttendanceData().sort((a, b) => new Date(b.date) - new Date(a.date));
            attendanceTableBody.innerHTML = '';
            if (data.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.date}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.shift}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.name}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.role || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.area || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakIn || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakOut || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
        }

        if (countersForm) {
            countersForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('counter-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('counter-date').value,
                    shift: document.getElementById('counter-shift').value,
                    required: Number(document.getElementById('counter-required').value),
                    // active is now derived
                };

                let data = getCountersData();
                if (editId) {
                    const index = data.findIndex(item => item.id === editId);
                    if (index > -1) data[index] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveCountersData(data);
                renderCountersTable();
                
                // Reset form but keep date
                const currentDate = document.getElementById('counter-date').value;
                countersForm.reset();
                document.getElementById('counter-date').value = currentDate;
                
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
            });
        }

        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-counter-btn')) {
                    if(confirm('Delete this record?')) {
                        let data = getCountersData();
                        data = data.filter(item => item.id !== id);
                        saveCountersData(data);
                        renderCountersTable();
                    }
                } else if (btn.classList.contains('edit-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('counter-edit-id').value = item.id;
                        document.getElementById('counter-date').value = item.date;
                        document.getElementById('counter-shift').value = item.shift;
                        document.getElementById('counter-required').value = item.required;
                        
                        saveCounterBtn.innerHTML = 'Update';
                        cancelCounterEditBtn.style.display = 'inline-flex';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            });
        }

        if (cancelCounterEditBtn) {
            cancelCounterEditBtn.addEventListener('click', () => {
                countersForm.reset();
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
                document.getElementById('counter-date').valueAsDate = new Date();
            });
        }

        if (attendanceForm) {
            attendanceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newEntry = {
                    id: Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    name: document.getElementById('att-name').value.trim(),
                    role: document.getElementById('att-role').value,
                    area: document.getElementById('att-area').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value
                };
                if(!newEntry.name) return;

                let data = getAttendanceData();
                data.push(newEntry);
                saveAttendanceData(data);
                
                document.getElementById('att-name').value = '';
                document.getElementById('att-break-in').value = '';
                document.getElementById('att-break-out').value = '';
                renderAttendanceTable();
                renderCountersTable(); // Update counts
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-att-btn')) {
                    if(confirm('Remove this person?')) {
                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        renderCountersTable(); // Update counts
                    }
                }
            });
        }

        renderCountersTable();
        renderAttendanceTable();
    });
  </script>
</body>
</html>
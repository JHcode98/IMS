<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Cycle Counters - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    .completion-high { color: #2ecc71; font-weight: bold; }
    .completion-med { color: #f1c40f; font-weight: bold; }
    .completion-low { color: #e74c3c; font-weight: bold; }
    
    /* Flip Card Styles */
    .flip-container { perspective: 1000px; position: relative; margin-bottom: 20px; }
    .flip-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
    .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { 
        backface-visibility: hidden; width: 100%; top: 0; left: 0; 
        background: var(--card); border-radius: 8px; 
    }
    .flip-front { z-index: 2; transform: rotateY(0deg); position: relative; }
    .flip-back { transform: rotateY(180deg); position: absolute; height: 100%; top: 0; overflow-y: auto; }
  </style>
  <style>
    /* Card content expand/collapse */
    .card-content.hidden { display: none; }
    /* Resizable box */
    .resizable-box {
        resize: both;
        overflow: auto;
        min-width: 300px;
        min-height: 200px;
    }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Reuse existing sidebar structure -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><button onclick="window.location.href='homepage.html'"><span class="menu-text">Homepage</span></button></li>
      <li><button onclick="window.location.href='cycle_count.html'" class="active"><span class="menu-text">Inventory Tracker</span></button></li>
    </ul>
  </nav>

  <header>
    <h1>Daily Cycle Counters</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <button class="nav-btn" onclick="window.location.href='cycle_count.html'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:5px;vertical-align:text-bottom;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          Back to Cycle Count
        </button>
      </div>
      <div class="nav-right">
        <div class="nav-user" id="nav-user">
          <a href="profile.html" title="Profile" style="text-decoration:none; margin-right: 4px;"><span id="nav-avatar" class="avatar small"></span></a>
          <button class="user-btn" id="user-btn"><span id="username-display"></span></button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="flip-container" id="counters-flip-container">
      <div class="flip-inner">
        <!-- Front: Manage Counters -->
        <div class="flip-front card resizable-box" id="manage-counters-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Manage Daily Counters</h2>
            <button class="icon-btn expand-toggle-btn" title="Toggle View" style="padding:4px; border:none; background:transparent; color:var(--muted);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
        </div>
        <div style="display:flex; gap:5px;">
            <button id="view-productivity-btn" class="icon-btn" title="View Productivity (Target vs Actual)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            </button>
            <button id="export-counters-btn" class="icon-btn" title="Export CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="archive-btn" class="icon-btn" title="Archive (Past Days)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
            </button>
        </div>
      </div>
      <div class="card-content">

      <!-- Form -->
      <form id="daily-counters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eef2f6;">
          <input type="hidden" id="counter-edit-id">
          <div>
              <label for="counter-date">Date</label>
              <input type="date" id="counter-date" required style="width:100%">
          </div>
          <div>
              <label for="counter-shift">Shift</label>
              <select id="counter-shift" required style="width:100%">
                  <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                  <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                  <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
              </select>
          </div>
          <div>
              <label for="counter-required">Required Counters</label>
              <input type="number" id="counter-required" required min="1" style="width:100%">
          </div>
          <div>
              <label for="counter-rate">Standard Rate</label>
              <input type="number" id="counter-rate" min="1" placeholder="Per Person" style="width:100%">
          </div>
          <div>
              <label for="counter-target">Target Output</label>
              <input type="number" id="counter-target" min="0" placeholder="Optional" style="width:100%">
          </div>
          <div style="display:flex; gap:5px;">
              <button type="submit" id="save-counter-btn" class="icon-btn" title="Save" style="background: #2752a7; color: white; height: 38px; width: 100%; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save
              </button>
              <button type="button" id="cancel-counter-edit-btn" class="icon-btn" title="Cancel Edit" style="background: #6c757d; color: white; height: 38px; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
          </div>
      </form>

      <!-- Table -->
      <div style="overflow-x: auto;">
          <table id="daily-counters-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">1st Shift (6am-2pm)</th>
                      <th style="padding: 12px; text-align: left;">2nd Shift (2pm-10pm)</th>
                      <th style="padding: 12px; text-align: left;">3rd Shift (10pm-6am)</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
      </div>
        </div>
        
        <!-- Back: Productivity View -->
        <div class="flip-back card resizable-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Productivity: Target vs Actual</h2>
                <button id="back-to-counters-btn" class="icon-btn" title="Back">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back
                </button>
            </div>
            <div style="position:relative; height:400px; width:100%;">
                <canvas id="productivity-chart"></canvas>
            </div>
        </div>
      </div>
    </div>

    <div class="card resizable-box" id="attendance-card" style="margin-top: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Attendance Sheet</h2>
            <button class="icon-btn expand-toggle-btn" title="Toggle View" style="padding:4px; border:none; background:transparent; color:var(--muted);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="att-search" placeholder="Search name..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="delete-selected-att-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
            <button id="add-att-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Entry
            </button>
        </div>
      </div>
      <div class="card-content">
      <div style="overflow-x: auto;">
          <table id="attendance-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left; width: 40px;"><input type="checkbox" id="select-all-att" title="Select All"></th>
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">Shift</th>
                      <th style="padding: 12px; text-align: left;">Name</th>
                      <th style="padding: 12px; text-align: left;">Role</th>
                      <th style="padding: 12px; text-align: left;">Area</th>
                      <th style="padding: 12px; text-align: left;">Break Out</th>
                      <th style="padding: 12px; text-align: left;">Break In</th>
                      <th style="padding: 12px; text-align: left;">Duration</th>
                      <th style="padding: 12px; text-align: left;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
      <div id="att-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="att-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="att-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
        <span id="att-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="att-prev-page" class="icon-btn" title="Previous">‹</button>
            <button id="att-next-page" class="icon-btn" title="Next">›</button>
        </div>
      </div>
      </div>
    </div>
  </main>

  <!-- Attendance Modal -->
  <div id="att-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="att-modal-title">Add Attendance</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <form id="att-modal-form" style="display: grid; gap: 15px;">
            <input type="hidden" id="att-edit-id">
            <div>
                <label for="att-date">Date</label>
                <input type="date" id="att-date" required style="width:100%">
            </div>
            <div>
                <label for="att-shift">Shift</label>
                <select id="att-shift" required style="width:100%">
                    <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                    <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                    <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
                </select>
            </div>
            <div>
                <label for="att-name">Counter Name</label>
                <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%">
            </div>
            <div>
                <label for="att-role">Role</label>
                <select id="att-role" style="width:100%">
                    <option value="IC Support">IC Support</option>
                    <option value="IC Back up">IC Back up</option>
                </select>
            </div>
            <div>
                <label for="att-area">Area</label>
                <select id="att-area" style="width:100%">
                    <option value="Pick Bin">Pick Bin</option>
                    <option value="Reserved Bin">Reserved Bin</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-break-out">Break Out</label>
                    <input type="time" id="att-break-out" style="width:100%">
                </div>
                <div>
                    <label for="att-break-in">Break In</label>
                    <input type="time" id="att-break-in" style="width:100%">
                </div>
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button type="button" class="icon-btn close-modal" style="margin-right:5px;">Cancel</button>
                <button type="submit" class="icon-btn" style="background: #2752a7; color: white;">Save</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Hourly Monitor Modal -->
  <div id="hourly-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card resizable-box" style="max-width: 800px; margin: 50px auto;">
        <input type="hidden" id="hourly-date-val">
        <input type="hidden" id="hourly-shift-val">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="hourly-modal-title">Hourly Output</h3>
            <div>
                <button id="save-hourly-targets-btn" class="icon-btn" title="Save Hourly Targets" style="background:#2752a7; color:white;">Save Targets</button>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        <div style="position:relative; height:400px; width:100%;">
            <canvas id="hourly-chart"></canvas>
        </div>
        <div id="hourly-details" style="margin-top:20px; max-height: 200px; overflow-y: auto;">
            <!-- Hourly input fields will be generated here -->
        </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        const countersForm = document.getElementById('daily-counters-form');
        const countersTableBody = document.querySelector('#daily-counters-table tbody');
        const cancelCounterEditBtn = document.getElementById('cancel-counter-edit-btn');
        const saveCounterBtn = document.getElementById('save-counter-btn');
        const archiveBtn = document.getElementById('archive-btn');
        const exportCountersBtn = document.getElementById('export-counters-btn');
        const dateInput = document.getElementById('counter-date');
        const rateInput = document.getElementById('counter-rate');
        const reqInput = document.getElementById('counter-required');
        const targetInput = document.getElementById('counter-target');
        
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        
        // Modal elements
        const attModal = document.getElementById('att-modal');
        const attForm = document.getElementById('att-modal-form');
        const addAttBtn = document.getElementById('add-att-btn');
        const attSearchInput = document.getElementById('att-search');
        
        // Hourly Modal
        const hourlyModal = document.getElementById('hourly-modal');
        let hourlyChart = null;

        // Flip elements
        const flipContainer = document.getElementById('counters-flip-container');
        const viewProdBtn = document.getElementById('view-productivity-btn');
        const backToCountersBtn = document.getElementById('back-to-counters-btn');
        let productivityChart = null;

        const STORAGE_KEY_COUNTERS = 'ims_daily_counters_v1';
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        const STORAGE_KEY_CC = 'ims_cycle_count_v1';
        
        let showArchiveOnly = false;
        let attCurrentPage = 1;
        let attItemsPerPage = 20;

        // Set default date
        if(dateInput) dateInput.valueAsDate = new Date();

        // Auto-calc target in form
        function autoCalcTarget() {
            const req = parseInt(reqInput.value) || 0;
            const rate = parseInt(rateInput.value) || 0;
            if (req > 0 && rate > 0) targetInput.value = req * rate;
        }
        if(rateInput) rateInput.addEventListener('input', autoCalcTarget);
        if(reqInput) reqInput.addEventListener('input', autoCalcTarget);

        function getCountersData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '[]');
            } catch (e) {
                console.error('Error parsing daily counters data', e);
                return [];
            }
        }

        function saveCountersData(data) {
            localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(data));
        }

        function getAttendanceData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }

        function renderCountersTable() {
            if (!countersTableBody) return;
            let data = getCountersData();
            const attendance = getAttendanceData();
            
            if (showArchiveOnly) {
                const today = new Date().toISOString().split('T')[0];
                data = data.filter(d => d.date < today);
            }
            
            // Group by Date
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.date]) grouped[item.date] = {};
                grouped[item.date][item.shift] = item;
            });
            
            const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            countersTableBody.innerHTML = '';
            if (dates.length === 0) {
                countersTableBody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding: 20px;">No daily counter records found.</td></tr>`;
                return;
            }
            
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            
            dates.forEach(date => {
                const tr = document.createElement('tr');
                let html = `<td style="padding:12px;border-bottom:1px solid #eee; font-weight:bold;">${date}</td>`;
                
                shifts.forEach(shift => {
                    const item = grouped[date][shift];
                    if (item) {
                        const req = Number(item.required) || 1;
                        const shiftAtt = attendance.filter(a => a.date === date && a.shift === shift);
                        const act = shiftAtt.length;
                        const pct = Math.round((act / req) * 100);
                        
                        // Calculate dynamic target based on active counters if rate exists
                        const rate = item.standardRate || 0;
                        const activeTarget = rate > 0 ? (act * rate) : (item.targetOutput || 0);
                        
                        // Visual indicator for shortage
                        const isShort = act < req;
                        const shortIndicator = isShort ? `<span title="Shortage: ${req - act}" style="color:#e74c3c; margin-left:5px; cursor:help;">⚠️</span>` : '';
                        
                        // Breakdowns
                        const areaCounts = {};
                        const roleCounts = {};
                        shiftAtt.forEach(a => {
                            if(a.area) areaCounts[a.area] = (areaCounts[a.area] || 0) + 1;
                            if(a.role) roleCounts[a.role] = (roleCounts[a.role] || 0) + 1;
                        });
                        const areaStr = Object.entries(areaCounts).map(([k,v]) => `${k}: ${v}`).join(', ');
                        const roleStr = Object.entries(roleCounts).map(([k,v]) => `${k}: ${v}`).join(', ');

                        let pctClass = 'completion-low';
                        if(pct >= 100) pctClass = 'completion-high';
                        else if(pct >= 80) pctClass = 'completion-med';
                        
                        html += `
                        <td style="padding:12px;border-bottom:1px solid #eee; vertical-align:top;">
                            <div style="font-size:13px; margin-bottom:4px;">Req: <strong>${req}</strong> | Act: <strong>${act}</strong> ${shortIndicator}</div>
                            ${rate > 0 ? `<div style="font-size:12px; color:#2752a7; margin-bottom:4px;">Target (Act): <strong>${activeTarget}</strong> <span class="muted" style="font-size:11px">(@${rate}/p)</span></div>` : ''}
                            <div class="${pctClass}" style="margin-top:4px; margin-bottom:6px;">${pct}% Completed</div>
                            ${areaStr ? `<div style="font-size:11px; color:#666; margin-bottom:2px;"><strong>Area:</strong> ${areaStr}</div>` : ''}
                            ${roleStr ? `<div style="font-size:11px; color:#666; margin-bottom:4px;"><strong>Role:</strong> ${roleStr}</div>` : ''}
                            <div style="margin-top:6px;">
                                <button class="icon-btn edit-counter-btn" data-id="${item.id}" title="Edit" style="padding:2px 6px; font-size:12px;">✎</button>
                                <button class="icon-btn hourly-btn" data-date="${date}" data-shift="${shift}" title="Hourly Monitor" style="padding:2px 6px; font-size:12px; background:#6f42c1; color:white; border:none;">Hourly</button>
                                <button class="icon-btn delete-counter-btn" data-id="${item.id}" title="Delete" style="padding:2px 6px; font-size:12px; color:#d9534f;">&times;</button>
                            </div>
                        </td>`;
                    } else {
                        html += `<td style="padding:12px;border-bottom:1px solid #eee; color:#ccc;">-</td>`;
                    }
                });
                tr.innerHTML = html;
                countersTableBody.appendChild(tr);
            });
        }

        // Hourly Monitor Logic
        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.hourly-btn');
                if (btn) {
                    const date = btn.dataset.date;
                    const shift = btn.dataset.shift;
                    openHourlyModal(date, shift);
                }
            });
        }

        function openHourlyModal(dateStr, shift) {
             document.getElementById('hourly-modal-title').textContent = `Hourly Output: ${dateStr} (${shift.split('-')[0]})`;
             hourlyModal.classList.remove('hidden');
             document.getElementById('hourly-date-val').value = dateStr;
             document.getElementById('hourly-shift-val').value = shift;
             
             // Find the counter entry to get the main target
             const counters = getCountersData();
             const counterEntry = counters.find(c => c.date === dateStr && c.shift === shift);
             
             // Determine time range
             const start = new Date(dateStr);
             const end = new Date(dateStr);
             
             if (shift.includes('1st Shift')) {
                 start.setHours(6,0,0,0); end.setHours(14,0,0,0);
             } else if (shift.includes('2nd Shift')) {
                 start.setHours(14,0,0,0); end.setHours(22,0,0,0);
             } else { // 3rd Shift
                 start.setHours(22,0,0,0); 
                 end.setDate(end.getDate() + 1); end.setHours(6,0,0,0);
             }
 
             // Fetch and filter data
             let cycleCounts = [];
             try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
             
             const hourlyDetailsContainer = document.getElementById('hourly-details');
             hourlyDetailsContainer.innerHTML = '';
             let hourlyDetailsHtml = '<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px; font-weight: bold; padding-bottom: 5px; border-bottom: 1px solid #eee;"><p>Hour</p><p>Actual</p><p>Target</p></div>';

             const hourlyData = {};
             const hourlyTargets = {};
             const defaultHourlyTarget = counterEntry && counterEntry.targetOutput > 0 ? Math.round(counterEntry.targetOutput / 8) : 0;

             // Initialize hours
             for (let d = new Date(start); d < end; d.setHours(d.getHours() + 1)) {
                 const h = d.getHours();
                 const label = `${h}:00 - ${h+1}:00`;
                 hourlyData[label] = 0;
                 // Use saved hourly target or default
                 const savedTarget = counterEntry && counterEntry.hourlyTargets && counterEntry.hourlyTargets[label];
                 hourlyTargets[label] = savedTarget !== undefined ? savedTarget : defaultHourlyTarget;
             }
 
             cycleCounts.forEach(c => {
                 const ts = c.createdDate || c.date;
                 if (ts) {
                     const d = new Date(ts);
                     if (d >= start && d < end) {
                         const h = d.getHours();
                         const label = `${h}:00 - ${h+1}:00`;
                         if (hourlyData.hasOwnProperty(label)) hourlyData[label]++;
                     }
                 }
             });
 
             // Build details table and populate targets
             Object.keys(hourlyData).forEach(label => {
                hourlyDetailsHtml += `<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center; padding: 5px 0;">
                    <div>${label}</div><div>${hourlyData[label]}</div>
                    <div><input type="number" class="hourly-target-input" data-hour="${label}" value="${hourlyTargets[label]}" style="width: 80px; padding: 4px;"></div></div>`;
             });
             hourlyDetailsContainer.innerHTML = hourlyDetailsHtml;

             // Calculate cumulative data
             const hourlyValues = Object.values(hourlyData);
             const cumulativeData = [];
             let sum = 0;
             for (const value of hourlyValues) {
                 sum += value;
                 cumulativeData.push(sum);
             }

             const targetLineData = Object.values(hourlyTargets);
 
             const ctx = document.getElementById('hourly-chart');
             if (hourlyChart) hourlyChart.destroy();
             hourlyChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: Object.keys(hourlyData),
                    datasets: [
                        { label: 'Hourly Output', data: hourlyValues, backgroundColor: '#36b9cc', order: 2 },
                        { label: 'Cumulative Total', data: cumulativeData, type: 'line', borderColor: '#e74c3c', backgroundColor: 'transparent', tension: 0.1, yAxisID: 'y', order: 1 },
                        { label: 'Target', data: targetLineData, type: 'line', borderColor: '#27ae60', backgroundColor: 'transparent', tension: 0.1, yAxisID: 'y', borderDash: [5, 5], order: 0 }
                    ]
                 },
                 options: { 
                     responsive: true, maintainAspectRatio: false, 
                     scales: { y: { beginAtZero: true, title: { display: true, text: 'Items Counted' } } } 
                 }
             });
        }

        // Save Hourly Targets
        const saveHourlyTargetsBtn = document.getElementById('save-hourly-targets-btn');
        if (saveHourlyTargetsBtn) {
            saveHourlyTargetsBtn.addEventListener('click', () => {
                const dateStr = document.getElementById('hourly-date-val').value;
                const shift = document.getElementById('hourly-shift-val').value;

                const counters = getCountersData();
                const counterIndex = counters.findIndex(c => c.date === dateStr && c.shift === shift);

                if (counterIndex > -1) {
                    if (!counters[counterIndex].hourlyTargets) counters[counterIndex].hourlyTargets = {};
                    document.querySelectorAll('.hourly-target-input').forEach(input => {
                        const hour = input.dataset.hour;
                        const value = parseInt(input.value, 10);
                        if (!isNaN(value) && value >= 0) {
                            counters[counterIndex].hourlyTargets[hour] = value;
                        }
                    });
                    saveCountersData(counters);
                    alert('Hourly targets saved!');
                }
            });
        }

        if (exportCountersBtn) {
            exportCountersBtn.addEventListener('click', () => {
                const counters = getCountersData();
                const attendance = getAttendanceData();
                
                if (counters.length === 0) {
                    alert('No data to export.');
                    return;
                }

                // Sort by date desc, then shift
                counters.sort((a, b) => {
                    if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                const headers = ['Date', 'Shift', 'Required', 'Active', 'Completion %'];
                const rows = [headers.join(',')];

                counters.forEach(item => {
                    const req = Number(item.required) || 1;
                    const act = attendance.filter(a => a.date === item.date && a.shift === item.shift).length;
                    const pct = Math.round((act / req) * 100);
                    
                    rows.push([
                        item.date,
                        `"${item.shift}"`,
                        req,
                        act,
                        item.targetOutput || 0,
                        `${pct}%`
                    ].join(','));
                });

                const csvContent = rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'daily_counters_summary.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if (archiveBtn) {
            archiveBtn.addEventListener('click', () => {
                showArchiveOnly = !showArchiveOnly;
                archiveBtn.classList.toggle('active-filter', showArchiveOnly);
                renderCountersTable();
            });
        }

        function getDuration(start, end) {
            if (!start || !end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (minutes < 0) minutes += 24 * 60;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return (h > 0 ? h + 'h ' : '') + m + 'm';
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) attItemsPerPage = parseInt(attRowsPerPageSelect.value, 10);

            let data = getAttendanceData().sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const searchTerm = attSearchInput ? attSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                data = data.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.role && item.role.toLowerCase().includes(searchTerm)) ||
                    (item.area && item.area.toLowerCase().includes(searchTerm))
                );
            }

            // Pagination
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / attItemsPerPage) || 1;
            if (attCurrentPage > totalPages) attCurrentPage = totalPages;

            const paginatedData = data.slice((attCurrentPage - 1) * attItemsPerPage, attCurrentPage * attItemsPerPage);

            attendanceTableBody.innerHTML = '';
            const paginationControls = document.getElementById('att-pagination-controls');
            if (paginationControls) {
                if (totalItems <= attItemsPerPage) {
                    paginationControls.style.display = 'none';
                } else {
                    paginationControls.style.display = 'flex';
                    document.getElementById('att-page-info').textContent = `Page ${attCurrentPage} of ${totalPages} (${totalItems} records)`;
                    document.getElementById('att-prev-page').disabled = attCurrentPage <= 1;
                    document.getElementById('att-next-page').disabled = attCurrentPage >= totalPages;
                }
            }

            if (paginatedData.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="10" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:12px;border-bottom:1px solid #eee"><input type="checkbox" class="att-row-checkbox" data-id="${item.id}"></td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.date}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.shift}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.name}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.role || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.area || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakOut || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">${item.breakIn || '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee; font-weight:bold; color:#555;">${getDuration(item.breakOut, item.breakIn)}</td>
                    <td style="padding:12px;border-bottom:1px solid #eee">
                        <button class="icon-btn edit-att-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">✎</button>
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
        }

        // Mass Delete for Attendance
        const selectAllAtt = document.getElementById('select-all-att');
        const deleteSelectedAttBtn = document.getElementById('delete-selected-att-btn');

        function updateAttendanceActionButtons() {
            const selectedCount = document.querySelectorAll('.att-row-checkbox:checked').length;
            if (deleteSelectedAttBtn) {
                deleteSelectedAttBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
        }

        if (selectAllAtt) {
            selectAllAtt.addEventListener('change', (e) => {
                document.querySelectorAll('.att-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateAttendanceActionButtons();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('att-row-checkbox')) {
                    updateAttendanceActionButtons();
                }
            });
        }

        if (deleteSelectedAttBtn) {
            deleteSelectedAttBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) { alert('No items selected.'); return; }
                if (confirm(`Are you sure you want to delete ${selectedIds.length} selected attendance records?`)) {
                    let data = getAttendanceData();
                    data = data.filter(item => !selectedIds.includes(item.id));
                    saveAttendanceData(data);
                    renderAttendanceTable();
                    renderCountersTable();
                    updateAttendanceActionButtons();
                }
            });
        }

        if (attSearchInput) {
            attSearchInput.addEventListener('input', () => {
                attCurrentPage = 1;
                renderAttendanceTable();
            });
        }

        const attPaginationControls = document.getElementById('att-pagination-controls');
        if (attPaginationControls) {
            attPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'att-prev-page' && !e.target.disabled) {
                    attCurrentPage--;
                    renderAttendanceTable();
                } else if (e.target.id === 'att-next-page' && !e.target.disabled) {
                    attCurrentPage++;
                    renderAttendanceTable();
                }
            });
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) {
                attRowsPerPageSelect.addEventListener('change', () => {
                    attCurrentPage = 1;
                    renderAttendanceTable();
                });
            }
        }

        if (countersForm) {
            countersForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('counter-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('counter-date').value,
                    shift: document.getElementById('counter-shift').value,
                    required: Number(document.getElementById('counter-required').value),
                    standardRate: Number(document.getElementById('counter-rate').value) || 0,
                    targetOutput: Number(document.getElementById('counter-target').value) || 0
                    // active is now derived
                };

                let data = getCountersData();
                if (editId) {
                    const index = data.findIndex(item => item.id === editId);
                    if (index > -1) data[index] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveCountersData(data);
                renderCountersTable();
                
                // Reset form but keep date
                const currentDate = document.getElementById('counter-date').value;
                countersForm.reset();
                document.getElementById('counter-date').value = currentDate;
                
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
            });
        }

        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-counter-btn')) {
                    if(confirm('Delete this record?')) {
                        let data = getCountersData();
                        data = data.filter(item => item.id !== id);
                        saveCountersData(data);
                        renderCountersTable();
                    }
                } else if (btn.classList.contains('edit-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('counter-edit-id').value = item.id;
                        document.getElementById('counter-date').value = item.date;
                        document.getElementById('counter-shift').value = item.shift;
                        document.getElementById('counter-required').value = item.required;
                        document.getElementById('counter-rate').value = item.standardRate || '';
                        document.getElementById('counter-target').value = item.targetOutput || '';
                        
                        saveCounterBtn.innerHTML = 'Update';
                        cancelCounterEditBtn.style.display = 'inline-flex';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            });
        }

        if (cancelCounterEditBtn) {
            cancelCounterEditBtn.addEventListener('click', () => {
                countersForm.reset();
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
                document.getElementById('counter-rate').value = '';
                document.getElementById('counter-date').valueAsDate = new Date();
            });
        }

        // Attendance Modal Logic
        if (addAttBtn) {
            addAttBtn.addEventListener('click', () => {
                document.getElementById('att-modal-title').textContent = 'Add Attendance';
                attForm.reset();
                document.getElementById('att-edit-id').value = '';
                document.getElementById('att-date').valueAsDate = new Date();
                attModal.classList.remove('hidden');
            });
        }

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) modal.classList.add('hidden');
            });
        });

        if (attForm) {
            attForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('att-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    name: document.getElementById('att-name').value.trim(),
                    role: document.getElementById('att-role').value,
                    area: document.getElementById('att-area').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value
                };
                if(!newEntry.name) return;

                let data = getAttendanceData();
                if (editId) {
                    const idx = data.findIndex(x => x.id === editId);
                    if (idx > -1) data[idx] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveAttendanceData(data);
                
                attModal.classList.add('hidden');
                renderAttendanceTable();
                renderCountersTable(); // Update counts
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-att-btn')) {
                    if(confirm('Remove this person?')) {
                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        renderCountersTable(); // Update counts
                    }
                } else if (btn.classList.contains('edit-att-btn')) {
                    const data = getAttendanceData();
                    const item = data.find(x => x.id === id);
                    if (item) {
                        document.getElementById('att-modal-title').textContent = 'Edit Attendance';
                        document.getElementById('att-edit-id').value = item.id;
                        document.getElementById('att-date').value = item.date;
                        document.getElementById('att-shift').value = item.shift;
                        document.getElementById('att-name').value = item.name;
                        document.getElementById('att-role').value = item.role;
                        document.getElementById('att-area').value = item.area;
                        document.getElementById('att-break-out').value = item.breakOut;
                        document.getElementById('att-break-in').value = item.breakIn;
                        attModal.classList.remove('hidden');
                    }
                }
            });
        }

        // Expand/Collapse Card Logic
        document.querySelectorAll('.expand-toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                const content = card.querySelector('.card-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.title = isHidden ? 'Expand' : 'Collapse';
                    btn.innerHTML = isHidden ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
                }
            });
        });

        // Productivity / Flip Logic
        if(viewProdBtn && flipContainer) {
            viewProdBtn.addEventListener('click', () => {
                flipContainer.classList.add('flipped');
                renderProductivityChart();
            });
        }
        if(backToCountersBtn && flipContainer) {
            backToCountersBtn.addEventListener('click', () => {
                flipContainer.classList.remove('flipped');
            });
        }

        function getShiftFromTimestamp(ts) {
            const d = new Date(ts);
            const h = d.getHours();
            let dateStr = d.toISOString().split('T')[0];
            let shift = '';
            
            if (h >= 6 && h < 14) {
                shift = '1st Shift-(6am-2pm)';
            } else if (h >= 14 && h < 22) {
                shift = '2nd Shift-(2pm-10pm)';
            } else {
                shift = '3rd Shift-(10pm-6am)';
                if (h < 6) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - 1);
                    dateStr = prev.toISOString().split('T')[0];
                }
            }
            return { date: dateStr, shift };
        }

        function renderProductivityChart() {
            const ctx = document.getElementById('productivity-chart');
            if(!ctx) return;
            
            const counters = getCountersData(); // Targets
            let cycleCounts = [];
            try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
            
            // Aggregate Actuals
            const actualsMap = {}; // Key: "Date|Shift" -> count
            cycleCounts.forEach(c => {
                const ts = c.createdDate || c.date;
                if(ts) {
                    const info = getShiftFromTimestamp(ts);
                    const key = `${info.date}|${info.shift}`;
                    actualsMap[key] = (actualsMap[key] || 0) + 1;
                }
            });

            // Prepare Chart Data (Sort by date desc, take top 10 or so)
            // We use counters list as the base for X-axis
            const sortedCounters = counters.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10); // Last 10 shifts
            
            const labels = [];
            const targetData = [];
            const actualData = [];

            sortedCounters.reverse().forEach(c => {
                labels.push(`${c.date} (${c.shift.split('-')[0]})`);
                targetData.push(c.targetOutput || 0);
                const key = `${c.date}|${c.shift}`;
                actualData.push(actualsMap[key] || 0);
            });

            if(productivityChart) productivityChart.destroy();
            productivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Target Output', data: targetData, backgroundColor: '#e74c3c' },
                        { label: 'Actual Output', data: actualData, backgroundColor: '#2ecc71' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        renderCountersTable();
        renderAttendanceTable();
    });
  </script>
</body>
</html>
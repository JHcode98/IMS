<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IR Monitoring - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eef2f6; margin-bottom: 20px; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
    .btn-primary { background-color: #2752a7; color: white; }
    .btn-primary:hover { background-color: #1f4287; }
    
    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 50%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
    th { background-color: #f8f9fa; font-weight: 600; color: #444; }
    tr:hover { background-color: #f9f9f9; }
    
    .search-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
    
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; }
    .pagination button { padding: 5px 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; }
    .pagination button:disabled { background: #eee; cursor: not-allowed; color: #999; }
  </style>
</head>
<body class="inventory-mode">
  <!-- Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button class="active" onclick="window.location.href='index.html'" data-tooltip="Document Monitoring">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          <span class="menu-text">Document Monitoring</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
            <li><button onclick="window.location.href='index.html'">IAAF Monitoring</button></li>
            <li><button class="active" onclick="window.location.href='ir_monitoring.html'">IR Monitoring</button></li>
        </ul>
      </li>
      <li>
        <button onclick="window.location.href='cycle_count.html'" data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu">
          <li><button onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
          <li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
          <li><button onclick="window.location.href='cycle_count_completion.html'">Cycle Count Completion</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Incident Report Monitoring</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <!-- Optional back button or similar -->
      </div>
      <div class="nav-right">
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>Incident Reports</h2>
        <div style="display:flex; gap:10px;">
          <button id="export-csv-btn" class="btn" style="background-color:#28a745; color:white;">Export CSV</button>
          <button id="import-csv-btn" class="btn" style="background-color:#17a2b8; color:white;">Import CSV</button>
          <input type="file" id="import-csv-file" accept=".csv" style="display:none">
          <button id="download-template-btn" class="btn" style="background-color:#6c757d; color:white;">Download Template</button>
          <button id="add-incident-btn" class="btn btn-primary">Log New Incident</button>
        </div>
      </div>

      <!-- Charts Section -->
      <div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px;">
        <div style="flex:1; min-width:300px; height:300px; border:1px solid #eee; padding:10px; border-radius:8px;">
            <canvas id="chart-role"></canvas>
        </div>
        <div style="flex:1; min-width:300px; height:300px; border:1px solid #eee; padding:10px; border-radius:8px;">
            <canvas id="chart-month"></canvas>
        </div>
        <div style="flex:1; min-width:300px; height:300px; border:1px solid #eee; padding:10px; border-radius:8px;">
            <canvas id="chart-description"></canvas>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="search-input" class="search-box" style="margin-bottom:0; flex:2;" placeholder="Multi Search: Filter by IR Control Number, Role, Description...">
        <select id="filter-role" class="search-box" style="margin-bottom:0; flex:1;">
          <option value="">All Roles</option>
          <option value="Replen">Replen</option>
          <option value="Putaway">Putaway</option>
          <option value="IC">IC</option>
          <option value="Receving">Receving</option>
          <option value="RTV">RTV</option>
          <option value="Packer">Packer</option>
          <option value="Picker">Picker</option>
          <option value="CSR">CSR</option>
          <option value="Retriever">Retriever</option>
          <option value="Dispatch">Dispatch</option>
          <option value="Others">Others</option>
        </select>
      </div>

      <div style="overflow-x:auto;">
        <table id="ir-table">
          <thead>
            <tr>
              <th>IR Control Number</th>
              <th>Updated Date</th>
              <th>Created Date</th>
              <th>Role</th>
              <th>Person Involved</th>
              <th>Description</th>
              <th>Attachment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pagination-controls" class="pagination"></div>
      <p id="no-data-msg" style="text-align:center; color:#666; margin-top:20px; display:none;">No incident reports found.</p>
    </div>
  </main>

  <!-- Modal -->
  <div id="incident-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">Log Incident</h3>
      <form id="incident-form">
        <div class="form-group">
          <label for="ir-id">IR Control Number</label>
          <input type="text" id="ir-id" required placeholder="ECOM-YYYY-XXXX">
        </div>
        <div class="form-group">
          <label for="ir-role">Role</label>
          <select id="ir-role" required>
            <option value="">Select Role</option>
            <option value="Replen">Replen</option>
            <option value="Putaway">Putaway</option>
            <option value="IC">IC</option>
            <option value="Receving">Receving</option>
            <option value="RTV">RTV</option>
            <option value="Packer">Packer</option>
            <option value="Picker">Picker</option>
            <option value="CSR">CSR</option>
            <option value="Retriever">Retriever</option>
            <option value="Dispatch">Dispatch</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ir-person">Person Involved (Optional)</label>
          <input type="text" id="ir-person" placeholder="Name of person involved">
        </div>
        <div class="form-group">
          <label for="ir-desc">Description</label>
          <textarea id="ir-desc" rows="4" required placeholder="Describe the incident..."></textarea>
        </div>
        <div class="form-group">
          <label for="ir-attachment">Attachments (PDF/Picture)</label>
          <input type="file" id="ir-attachment" accept="image/*,application/pdf" multiple>
          <small style="color:#666;">Max size: 2MB (for demo purposes)</small>
        </div>
        <div style="text-align:right; margin-top:35px;">
            <button type="button" class="btn" style="background:#eee; color:#333; margin-right:10px;" id="cancel-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Incident</button>
        </div>
      </form>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        if(!localStorage.getItem('dms_auth_v1')) {
            window.location.href = 'index.html';
            return;
        }
        
        // Sidebar Toggle
        const mainSidebarToggle = document.getElementById('main-sidebar-toggle');
        if (mainSidebarToggle) {
          mainSidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
            document.getElementById('app-sidebar').classList.toggle('collapsed');
            // Resize charts after sidebar animation
            setTimeout(() => {
                [roleChartInstance, monthChartInstance, descChartInstance].forEach(c => c && c.resize());
            }, 300);
          });
        }

    const STORAGE_KEY_IR = 'ims_ir_records_v1';
    let irData = [];
    try {
        irData = JSON.parse(localStorage.getItem(STORAGE_KEY_IR) || '[]');
        if (!Array.isArray(irData)) irData = [];
    } catch(e) {
        console.error("Failed to parse IR data, resetting.", e);
        irData = [];
        localStorage.removeItem(STORAGE_KEY_IR);
    }
    let filteredData = [...irData];
    let currentPage = 1;
    const itemsPerPage = 5;
    let roleChartInstance = null;
    let monthChartInstance = null;
    let descChartInstance = null;

    function renderTable() {
        const tbody = document.querySelector('#ir-table tbody');
        const noDataMsg = document.getElementById('no-data-msg');
        const paginationControls = document.getElementById('pagination-controls');
        tbody.innerHTML = '';
        
        const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = filteredData.slice(start, end);
        
        if(filteredData.length === 0) {
            noDataMsg.style.display = 'block';
            paginationControls.style.display = 'none';
        } else {
            noDataMsg.style.display = 'none';
            paginationControls.style.display = 'flex';
            
            pageData.forEach((item, index) => {
                const tr = document.createElement('tr');
                let attachmentLinks = '<span style="color:#999">None</span>';
                
                // Normalize attachments to array
                let attachments = item.attachments || (item.attachment ? [item.attachment] : []);
                
                if(attachments.length > 0) {
                    attachmentLinks = attachments.map((att, i) => {
                        if(att.startsWith('data:')) {
                            const type = att.split(';')[0].split(':')[1];
                            const label = type.includes('pdf') ? 'PDF' : 'Img';
                            return `<a href="#" onclick="openAttachment('${item.id}', ${i}); return false;">${label} ${i+1}</a>`;
                        } else {
                            return `<a href="${att}" target="_blank">View</a>`;
                        }
                    }).join(', ');
                }

                const updatedDate = item.updatedDate ? new Date(item.updatedDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : 'N/A');
                const createdDate = item.createdDate ? new Date(item.createdDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : 'N/A');

                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${updatedDate}</td>
                    <td>${createdDate}</td>
                    <td>${item.role || ''}</td>
                    <td>${item.person || '-'}</td>
                    <td>${item.description}</td>
                    <td>${attachmentLinks}</td>
                    <td>
                        <button onclick="editIncident('${item.id}')" style="color:#2752a7; border:none; background:none; cursor:pointer; font-weight:bold; margin-right:5px;">Edit</button>
                        <button onclick="deleteIncident('${item.id}')" style="color:#d9534f; border:none; background:none; cursor:pointer; font-weight:bold;">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Render Pagination Controls
        paginationControls.innerHTML = `
            <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${currentPage} of ${totalPages}</span>
            <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
        `;
    }

    function updateCharts() {
        // Aggregate Role Data
        const roleCounts = {};
        irData.forEach(item => {
            const r = item.role || 'Unknown';
            roleCounts[r] = (roleCounts[r] || 0) + 1;
        });

        // Aggregate Month Data
        const monthCounts = {};
        irData.forEach(item => {
            const d = new Date(item.createdDate || item.date);
            if(!isNaN(d.getTime())) {
                const key = d.toISOString().slice(0, 7); // YYYY-MM
                monthCounts[key] = (monthCounts[key] || 0) + 1;
            }
        });
        
        const sortedMonths = Object.keys(monthCounts).sort();
        const monthLabels = sortedMonths.map(m => m);
        const monthData = sortedMonths.map(m => monthCounts[m]);

        // Render Role Chart
        const ctxRole = document.getElementById('chart-role');
        if(roleChartInstance) roleChartInstance.destroy();
        roleChartInstance = new Chart(ctxRole, {
            type: 'bar',
            data: {
                labels: Object.keys(roleCounts),
                datasets: [{
                    label: 'Incidents by Role',
                    data: Object.values(roleCounts),
                    backgroundColor: '#4e73df'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Incidents by Role' } } }
        });

        // Render Month Chart
        const ctxMonth = document.getElementById('chart-month');
        if(monthChartInstance) monthChartInstance.destroy();
        monthChartInstance = new Chart(ctxMonth, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'Incidents per Month',
                    data: monthData,
                    borderColor: '#1cc88a',
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Incidents Trend' } } }
        });

        // Aggregate Description Data
        const descCounts = {};
        irData.forEach(item => {
            const d = (item.description || 'N/A').trim();
            descCounts[d] = (descCounts[d] || 0) + 1;
        });
        const summarizedDesc = summarizeMap(descCounts, 5);

        // Render Description Chart
        const ctxDesc = document.getElementById('chart-description');
        if(descChartInstance) descChartInstance.destroy();
        descChartInstance = new Chart(ctxDesc, {
            type: 'bar',
            data: {
                labels: Object.keys(summarizedDesc),
                datasets: [{
                    label: 'Incidents by Description',
                    data: Object.values(summarizedDesc),
                    backgroundColor: '#fd7e14'
                }]
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Top Incident Descriptions' }, legend: { display: false } } 
            }
        });
    }
    
    window.changePage = (delta) => {
        currentPage += delta;
        renderTable();
    };
    
    window.openAttachment = (id, index = 0) => {
        const item = irData.find(i => i.id === id);
        let attachments = item.attachments || (item.attachment ? [item.attachment] : []);
        const att = attachments[index];
        
        if(att) {
            const win = window.open();
            if(att.includes('application/pdf')) {
                 win.document.write('<iframe src="' + att + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            } else {
                 win.document.write('<img src="' + att + '" style="max-width:100%">');
            }
        }
    };

    // Search
    function applyFilter() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const roleFilter = document.getElementById('filter-role').value;
        const terms = term.split(/\s+/).filter(t => t.length > 0);
        
        filteredData = irData.filter(item => {
            const searchable = (item.id + ' ' + (item.role || item.department || '') + ' ' + (item.description || '')).toLowerCase();
            const matchesSearch = terms.every(term => searchable.includes(term));
            const matchesRole = roleFilter === '' || (item.role === roleFilter);
            return matchesSearch && matchesRole;
        });
        currentPage = 1;
        renderTable();
    }

    document.getElementById('search-input').addEventListener('input', applyFilter);
    document.getElementById('filter-role').addEventListener('change', applyFilter);

    document.getElementById('export-csv-btn').addEventListener('click', () => { // Updated
        const headers = ['IR Control Number', 'Updated Date', 'Created Date', 'Role', 'Person Involved', 'Description'];
        const rows = filteredData.map(item => [
            `"${item.id}"`,
            `"${item.updatedDate ? new Date(item.updatedDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : '')}"`,
            `"${item.createdDate ? new Date(item.createdDate).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : '')}"`,
            `"${item.role}"`,
            `"${item.person}"`,
            `"${(item.description || '').replace(/"/g, '""')}"`
        ]);
        const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'incident_reports.csv';
        link.click();
    });

    // Import / Download Template
    const importBtn = document.getElementById('import-csv-btn');
    const importFile = document.getElementById('import-csv-file');
    const downloadTemplateBtn = document.getElementById('download-template-btn');

    if(importBtn && importFile) {
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split(/\r\n|\n/);
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const requiredHeaders = ['IR Control Number', 'Role', 'Description'];
                    if (!requiredHeaders.every(h => headers.includes(h))) {
                        alert(`Import failed: CSV must contain headers: ${requiredHeaders.join(', ')}.`);
                        return;
                    }

                    let addedCount = 0;
                    let duplicateCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i]) continue;
                        const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        
                        const createdDate = headers.includes('Created Date') ? normalizeDate(values[headers.indexOf('Created Date')]) : (headers.includes('Date') ? normalizeDate(values[headers.indexOf('Date')]) : new Date().toISOString());
                        const updatedDate = headers.includes('Updated Date') ? normalizeDate(values[headers.indexOf('Updated Date')]) : createdDate;
                        const newRecord = {
                            id: values[headers.indexOf('IR Control Number')],
                            createdDate: createdDate,
                            updatedDate: updatedDate,
                            role: values[headers.indexOf('Role')],
                            person: headers.includes('Person Involved') ? values[headers.indexOf('Person Involved')] : '',
                            description: values[headers.indexOf('Description')],
                            attachments: []
                        };

                        if (newRecord.id && newRecord.role && newRecord.description) {
                            if (irData.some(d => d.id === newRecord.id)) {
                                duplicateCount++;
                            } else {
                                irData.unshift(newRecord);
                                addedCount++;
                            }
                        }
                    }
                    if (addedCount > 0 || duplicateCount > 0) {
                        localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
                        let msg = `${addedCount} records imported.`;
                        if (duplicateCount > 0) msg += ` ${duplicateCount} duplicates skipped.`;
                        alert(msg);
                        applyFilter();
                        updateCharts();
                    } else {
                        alert('No valid new records found to import.');
                    }
                } catch (error) {
                    alert('Failed to import CSV. Check file format.');
                } finally {
                    importFile.value = '';
                }
            };
            reader.readAsText(file);
        });
    }

    if(downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', () => {
            const headers = ['IR Control Number', 'Created Date', 'Updated Date', 'Role', 'Person Involved', 'Description'];
            const now = new Date().toLocaleString();
            const sample = ['ECOM-2024-0001', now, now, 'Picker', 'John Doe', 'Picked wrong item'];
            const csvContent = headers.join(',') + '\n' + sample.map(s => `"${s}"`).join(',');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ir_template.csv';
            link.click();
        });
    }

    // Modal Logic
    const modal = document.getElementById('incident-modal');
    const btn = document.getElementById('add-incident-btn');
    const span = document.getElementsByClassName("close")[0];
    const cancelBtn = document.getElementById('cancel-btn');
    
    const closeModal = () => {
        modal.style.display = "none";
        document.getElementById('incident-form').reset();
        delete document.getElementById('incident-form').dataset.editingId;
    }

    btn.onclick = () => {
        const year = new Date().getFullYear();
        const rand = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        document.getElementById('ir-id').value = `ECOM-${year}-${rand}`;
        modal.style.display = "block";
    };
    span.onclick = closeModal;
    cancelBtn.onclick = closeModal;
    window.onclick = (event) => { if (event.target == modal) closeModal(); }

    document.getElementById('incident-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('ir-id').value;
        const role = document.getElementById('ir-role').value;
        const person = document.getElementById('ir-person').value;
        const desc = document.getElementById('ir-desc').value;
        const fileInput = document.getElementById('ir-attachment');
        const editingId = e.target.dataset.editingId;
        
        // Validation: Unique ID
        if (!editingId && irData.some(i => i.id === id)) {
            alert('IR Control Number must be unique.');
            return;
        }
        if (editingId && id !== editingId && irData.some(i => i.id === id)) {
             alert('IR Control Number must be unique.');
             return;
        }

        const processRecord = (newAttachments) => {
            let attachments = newAttachments;
            
            if (editingId) { // Editing existing record
                const index = irData.findIndex(i => i.id === editingId);
                if (index !== -1) {
                    // If no new files, keep existing
                    if (!attachments || attachments.length === 0) {
                        attachments = irData[index].attachments || (irData[index].attachment ? [irData[index].attachment] : []);
                    }
                    const oldRecord = irData[index];
                    irData[index] = {
                        ...oldRecord,
                        id, role, person, description: desc, attachments,
                        createdDate: oldRecord.createdDate || oldRecord.date, // Preserve original creation date
                        updatedDate: new Date().toISOString()
                    };
                    delete irData[index].date; // Clean up old property
                }
            } else { // Creating new record
                const newRecord = {
                    id: id,
                    createdDate: new Date().toISOString(),
                    updatedDate: new Date().toISOString(),
                    role: role,
                    person: person,
                    description: desc,
                    attachments: attachments || []
                };
                irData.unshift(newRecord);
            }
            
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            applyFilter();
            updateCharts();
            closeModal();
        };

        if(fileInput.files.length > 0) {
            const files = Array.from(fileInput.files);
            const promises = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve(ev.target.result);
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(promises).then(results => {
                processRecord(results);
            });
        } else {
            processRecord([]);
        }
    });

    window.deleteIncident = (id) => {
        if(confirm('Delete this record?')) {
            irData = irData.filter(i => i.id !== id);
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            applyFilter();
            updateCharts();
        }
    };

    window.editIncident = (id) => {
        const item = irData.find(i => i.id === id);
        if(item) {
            document.getElementById('ir-id').value = item.id;
            document.getElementById('ir-role').value = item.role || '';
            document.getElementById('ir-person').value = item.person || '';
            document.getElementById('ir-desc').value = item.description;
            document.getElementById('incident-form').dataset.editingId = item.id;
            // Clear file input on edit
            document.getElementById('ir-attachment').value = '';
            modal.style.display = "block";
        }
    };

    renderTable();
    updateCharts();
    });
  </script>
</body>
</html>
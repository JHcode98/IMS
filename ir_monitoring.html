<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IR Monitoring - Inventory Management System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eef2f6; margin-bottom: 20px; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
    .btn-primary { background-color: #2752a7; color: white; }
    .btn-primary:hover { background-color: #1f4287; }
    
    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 50%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; vertical-align: top; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
    th { background-color: #f8f9fa; font-weight: 600; color: #444; }
    tr:hover { background-color: #f9f9f9; }
    
    .search-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
  </style>
</head>
<body class="inventory-mode">
  <!-- Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button class="active" onclick="window.location.href='index.html'" data-tooltip="Document Monitoring">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          <span class="menu-text">Document Monitoring</span>
        </button>
        <ul class="sidebar-submenu" style="display:block">
            <li><button onclick="window.location.href='index.html'">IAAF Monitoring</button></li>
            <li><button class="active" onclick="window.location.href='ir_monitoring.html'">IR Monitoring</button></li>
        </ul>
      </li>
      <li>
        <button onclick="window.location.href='cycle_count.html'" data-tooltip="Inventory Tracker">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        <span class="menu-text">Inventory Tracker</span>
        </button>
        <ul class="sidebar-submenu">
          <li><button onclick="window.location.href='cycle_count.html'">Cycle Count</button></li>
          <li><button onclick="window.location.href='cycle_count_reports.html'">Cycle Count Report</button></li>
          <li><button onclick="window.location.href='cycle_count_completion.html'">Cycle Count Completion</button></li>
        </ul>
      </li>
      <li><button onclick="window.location.href='settings.html'" data-tooltip="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span class="menu-text">Settings</span>
      </button></li>
    </ul>
  </nav>

  <header>
    <h1>Incident Report Monitoring</h1>
    <div class="navbar" role="navigation">
      <div class="nav-left">
        <!-- Optional back button or similar -->
      </div>
      <div class="nav-right">
        <div id="clock" class="clock" aria-live="polite"></div>
        <div class="nav-user" id="nav-user">
          <button class="user-btn" id="user-btn" aria-haspopup="true" aria-expanded="false"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></button>
          <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
            <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
            <button id="logout-btn" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>Incident Reports</h2>
        <button id="add-incident-btn" class="btn btn-primary">Log New Incident</button>
      </div>

      <input type="text" id="search-input" class="search-box" placeholder="Multi Search: Filter by ID, Role, Description...">

      <div style="overflow-x:auto;">
        <table id="ir-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Role</th>
              <th>Description</th>
              <th>Attachment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="no-data-msg" style="text-align:center; color:#666; margin-top:20px; display:none;">No incident reports found.</p>
    </div>
  </main>

  <!-- Modal -->
  <div id="incident-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">Log Incident</h3>
      <form id="incident-form">
        <div class="form-group">
          <label for="ir-role">Role</label>
          <select id="ir-role" required>
            <option value="">Select Role</option>
            <option value="Replen">Replen</option>
            <option value="Putaway">Putaway</option>
            <option value="IC">IC</option>
            <option value="Receving">Receving</option>
            <option value="RTV">RTV</option>
            <option value="Packer">Packer</option>
            <option value="Picker">Picker</option>
            <option value="CSR">CSR</option>
            <option value="Retriever">Retriever</option>
            <option value="Dispatch">Dispatch</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ir-desc">Description</label>
          <textarea id="ir-desc" rows="4" required placeholder="Describe the incident..."></textarea>
        </div>
        <div class="form-group">
          <label for="ir-attachment">Attachment (PDF/Picture)</label>
          <input type="file" id="ir-attachment" accept="image/*,application/pdf">
          <small style="color:#666;">Max size: 2MB (for demo purposes)</small>
        </div>
        <div style="text-align:right; margin-top:35px;">
            <button type="button" class="btn" style="background:#eee; color:#333; margin-right:10px;" id="cancel-btn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Incident</button>
        </div>
      </form>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    if(!localStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';
    
    // Sidebar Toggle
    const mainSidebarToggle = document.getElementById('main-sidebar-toggle');
    if (mainSidebarToggle) {
      mainSidebarToggle.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-collapsed');
        document.getElementById('app-sidebar').classList.toggle('collapsed');
      });
    }

    const STORAGE_KEY_IR = 'ims_ir_records_v1';
    let irData = JSON.parse(localStorage.getItem(STORAGE_KEY_IR) || '[]');

    function renderTable(data = irData) {
        const tbody = document.querySelector('#ir-table tbody');
        const noDataMsg = document.getElementById('no-data-msg');
        tbody.innerHTML = '';
        
        if(data.length === 0) {
            noDataMsg.style.display = 'block';
        } else {
            noDataMsg.style.display = 'none';
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                let attachmentLink = '<span style="color:#999">None</span>';
                if(item.attachment) {
                    // Check if it's a data URL
                    if(item.attachment.startsWith('data:')) {
                        const type = item.attachment.split(';')[0].split(':')[1];
                        const label = type.includes('pdf') ? 'View PDF' : 'View Image';
                        attachmentLink = `<a href="#" onclick="openAttachment('${item.id}'); return false;">${label}</a>`;
                    } else {
                        attachmentLink = item.attachment; // Fallback
                    }
                }
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${new Date(item.date).toLocaleString()}</td>
                    <td>${item.role || item.department || ''}</td>
                    <td>${item.description}</td>
                    <td>${attachmentLink}</td>
                    <td><button onclick="deleteIncident('${item.id}')" style="color:#d9534f; border:none; background:none; cursor:pointer; font-weight:bold;">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    
    window.openAttachment = (id) => {
        const item = irData.find(i => i.id === id);
        if(item && item.attachment) {
            const win = window.open();
            if(item.attachment.includes('application/pdf')) {
                 win.document.write('<iframe src="' + item.attachment + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            } else {
                 win.document.write('<img src="' + item.attachment + '" style="max-width:100%">');
            }
        }
    };

    // Search
    document.getElementById('search-input').addEventListener('input', (e) => {
        const terms = e.target.value.toLowerCase().split(/\s+/).filter(t => t.length > 0);
        const filtered = irData.filter(item => {
            const searchable = (item.id + ' ' + (item.role || item.department || '') + ' ' + (item.description || '')).toLowerCase();
            return terms.every(term => searchable.includes(term));
        });
        renderTable(filtered);
    });

    // Modal Logic
    const modal = document.getElementById('incident-modal');
    const btn = document.getElementById('add-incident-btn');
    const span = document.getElementsByClassName("close")[0];
    const cancelBtn = document.getElementById('cancel-btn');
    
    const closeModal = () => {
        modal.style.display = "none";
        document.getElementById('incident-form').reset();
    }

    btn.onclick = () => modal.style.display = "block";
    span.onclick = closeModal;
    cancelBtn.onclick = closeModal;
    window.onclick = (event) => { if (event.target == modal) closeModal(); }

    document.getElementById('incident-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const role = document.getElementById('ir-role').value;
        const desc = document.getElementById('ir-desc').value;
        const fileInput = document.getElementById('ir-attachment');
        
        const processRecord = (attachmentData) => {
            const newRecord = {
                id: 'IR-' + Date.now().toString().slice(-6),
                date: new Date().toISOString(),
                role: role,
                description: desc,
                attachment: attachmentData
            };
            irData.unshift(newRecord);
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            renderTable();
            closeModal();
        };

        if(fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if(file.size > 2 * 1024 * 1024) {
                alert('File is too large for this demo (Max 2MB).');
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                processRecord(ev.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            processRecord(null);
        }
    });

    window.deleteIncident = (id) => {
        if(confirm('Delete this record?')) {
            irData = irData.filter(i => i.id !== id);
            localStorage.setItem(STORAGE_KEY_IR, JSON.stringify(irData));
            renderTable();
        }
    };

    renderTable();
  </script>
</body>
</html>